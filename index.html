<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Patroli — Monitor + User (Merged)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<style>
  :root{
    --bg:#0b0b0d; --card:#0f1720; --muted:#9aa4b2; --accent:#ff2d55; --accent2:#ff2d55;
    --panelW:360px;
  }
  body{margin:0;font-family:Inter,system-ui,-apple-system,Roboto,Arial;background:var(--bg);color:#fff}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#060708}
  .wrap{display:grid;grid-template-columns:var(--panelW) 1fr;gap:12px;padding:12px;height:calc(100vh - 56px)}
  .card{background:linear-gradient(180deg,#071018,#051018);border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .controls .row{display:flex;gap:8px;margin-bottom:8px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#00bfa5);color:#021;border:0}
  #map{height:100%;border-radius:8px}
  .petugas-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer;margin-bottom:8px}
  .petugas-thumb{width:56px;height:56px;border-radius:8px;overflow:hidden}
  .petugas-thumb img{width:100%;height:100%;object-fit:cover}
  .small{color:var(--muted);font-size:13px}
  .hidden{display:none!important}
  .split-vert{display:flex;flex-direction:column;gap:10px;height:100%}
  .intel-photo{height:160px;border-radius:8px;overflow:hidden;background:#020202}
  .intel-photo img{width:100%;height:100%;object-fit:cover}
  .mission-log{max-height:200px;overflow:auto}
  .title{font-weight:800;margin-bottom:8px}
  /* responsive */
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} .map-panel{order:2} .left-panel{order:1} #map{height:50vh} }
</style>
</head>
<body>

<div class="topbar">
  <div style="font-weight:800">PATROLI — Monitor & User</div>
  <div class="small">Realtime via Firebase + Cloudinary</div>
</div>

<div class="wrap">
  <!-- LEFT: Admin Monitor (list + controls) -->
  <div class="card left-panel split-vert">
    <div>
      <div class="title">Kontrol Monitor</div>
      <div class="controls">
        <div class="row">
          <select id="filterShift"><option value="">-- Semua Shift --</option></select>
          <select id="filterStatus"><option value="">-- Semua Status --</option></select>
        </div>
        <div class="row">
          <button class="btn" id="btnExportCSV">Export CSV</button>
          <button class="btn" id="btnExportXLSX">Export XLSX</button>
          <button class="btn" id="btnEnableSound">Enable Sound</button>
        </div>
      </div>
    </div>

    <div style="margin-top:8px">
      <div class="title">Petugas Aktif</div>
      <div id="list" class="petugas-list"></div>
    </div>

    <div style="margin-top:auto">
      <div class="title">Detail / Intel</div>
      <div id="detail" style="padding:8px;border-radius:8px;background:linear-gradient(180deg,#071018,#051018)"></div>
      <div class="intel-photo" style="margin-top:8px"><img id="intelImg" src="" alt=""></div>
      <div class="mission-log" id="missionLog" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- RIGHT: Map -->
  <div class="card map-panel" style="display:flex;flex-direction:column;gap:8px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Peta — Monitoring</div>
      <div class="small">Auto-refresh • Follow • Filter</div>
    </div>
    <div id="map"></div>
  </div>
</div>

<!-- Minimal user app modal (quick test) -->
<!-- Not full user UI — quick uploader for testing -->
<div id="userModal" class="hidden" style="position:fixed;right:12px;bottom:12px;z-index:9999">
  <div class="card" style="width:320px">
    <div style="font-weight:800">User App (Quick)</div>
    <div style="margin-top:8px">
      <input id="officerName" placeholder="Nama petugas" style="width:100%;padding:8px;border-radius:8px;margin-bottom:8px"/>
      <input type="file" id="filePicker" accept="image/*" />
      <div style="margin-top:8px"><button class="btn primary" id="btnUpload">Upload Photo + Send GPS</button></div>
      <div class="small" style="margin-top:8px">(Gunakan ini jika ingin coba kirim data manual)</div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/*
  MERGED - Firebase config & Cloudinary settings
  (Using values extracted from your uploaded files)
*/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
  authDomain: "silitpitik7373.firebaseapp.com",
  projectId: "silitpitik7373",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  storageBucket: "silitpitik7373.appspot.com",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};

const CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };

// Init Firebase
if(!window.firebase || !firebase.apps || !firebase.apps.length){
  firebase.initializeApp(FIREBASE_CONFIG);
}
const db = firebase.database();
firebase.auth().onAuthStateChanged(u=>{
  if(!u) firebase.auth().signInAnonymously().catch(e=>console.warn('auth err',e));
});

// Cloudinary helper
function uploadToCloudinary(file){
  return new Promise((res,rej)=>{
    if(!file) return rej('no file');
    var url = 'https://api.cloudinary.com/v1_1/' + CLOUDINARY.cloudName + '/upload';
    var fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CLOUDINARY.uploadPreset);
    var xhr = new XMLHttpRequest(); xhr.open('POST', url, true);
    xhr.onreadystatechange = function(){ if(xhr.readyState==4){ if(xhr.status==200){ try{ res(JSON.parse(xhr.responseText).secure_url); }catch(e){ rej(e);} } else rej(xhr.responseText||xhr.status); } };
    xhr.send(fd);
  });
}

/* --- Map & UI --- */
let map = L.map('map').setView([-6.2,106.8166], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);

const markers = {}; // uid -> marker
function makeMarker(uid, lat, lon, label, photo){
  if(markers[uid]) {
    markers[uid].setLatLng([lat,lon]);
    if(photo) markers[uid].bindPopup(`<b>${label}</b><br><img src="${photo}" style="width:120px;height:80px;object-fit:cover"/>`);
    return;
  }
  const el = document.createElement('div'); el.className='pulse-marker';
  const marker = L.marker([lat,lon], {title:label}).addTo(map);
  marker.bindPopup(`<b>${label}</b><br>${lat.toFixed(6)}, ${lon.toFixed(6)}${photo?'<br><img src="'+photo+'" style="width:120px;height:80px;object-fit:cover"/>':''}`);
  markers[uid]=marker;
}

/* --- Listen to /live entries --- */
const liveRef = db.ref('live');
liveRef.on('value', snap=>{
  const data = snap.val() || {};
  renderList(data);
  // update markers
  Object.keys(data).forEach(uid=>{
    const item = data[uid] || {};
    const gps = item.lastGps || {};
    const name = (item.presence && item.presence.officerName) || uid;
    const photo = (item.photoUrl) || null;
    if(gps && gps.lat && gps.lon) makeMarker(uid, gps.lat, gps.lon, name, photo);
  });
});

/* --- Render list of petugas --- */
function renderList(data){
  const list = document.getElementById('list'); list.innerHTML='';
  const keys = Object.keys(data).sort();
  keys.forEach(k=>{
    const it = data[k]||{};
    const pres = it.presence || {};
    const last = pres.lastSeen ? (new Date(pres.lastSeen)).toLocaleString() : '—';
    const name = pres.officerName || k;
    const photo = it.photoUrl || '';
    const el = document.createElement('div'); el.className='petugas-item';
    el.innerHTML = `<div class="petugas-thumb"><img src="${photo||'https://res.cloudinary.com/demo/image/upload/w_200,h_140,c_thumb/sample.jpg'}" /></div>
      <div style="flex:1">
        <div style="font-weight:700">${name}</div>
        <div class="small">Last: ${last}</div>
      </div>`;
    el.onclick = ()=> showDetail(k, it);
    list.appendChild(el);
  });
}

/* --- Detail panel --- */
function showDetail(uid, data){
  const detail = document.getElementById('detail');
  const pres = data.presence || {};
  const gps = data.lastGps || {};
  detail.innerHTML =
    `<div style="font-weight:800">${pres.officerName||uid}</div>
     <div class="small">Last seen: ${pres.lastSeen? new Date(pres.lastSeen).toLocaleString() : '—'}</div>
     <div class="small">GPS: ${gps.lat||''}, ${gps.lon||''}</div>
     <div style="margin-top:8px">${data.message || ''}</div>`;
  const intelImg = document.getElementById('intelImg');
  intelImg.src = data.photoUrl || '';
  // center map
  if(gps.lat && gps.lon) map.setView([gps.lat,gps.lon], 15);
}

/* --- Export CSV/XLSX (basic) --- */
function exportCSV(rows, filename){
  const csv = rows.map(r=>Object.values(r).map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = filename; document.body.appendChild(a); a.click();
}
document.getElementById('btnExportCSV').onclick = async ()=> {
  const snap = await db.ref('patroli').once('value'); const d = snap.val()||{};
  const rows=[];
  Object.keys(d).forEach(uid=>{ Object.values(d[uid]||{}).forEach(entry=> rows.push({ uid, time:entry.time || '', officer:entry.officer || '', lat:entry.lat||'', lon:entry.lon||'', photo:entry.photo||'', desc:entry.desc||'' }))});
  exportCSV(rows, 'patroli_export_'+Date.now()+'.csv');
};
/* XLSX (basic) */
document.getElementById('btnExportXLSX').onclick = async ()=>{
  const snap = await db.ref('patroli').once('value'); const d = snap.val()||{};
  const rows=[['uid','time','officer','lat','lon','photo','desc']];
  Object.keys(d).forEach(uid=>{ Object.values(d[uid]||{}).forEach(entry=> rows.push([uid, entry.time||'', entry.officer||'', entry.lat||'', entry.lon||'', entry.photo||'', entry.desc||'']))});
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb,ws,'patroli');
  XLSX.writeFile(wb, 'patroli_export_'+Date.now()+'.xlsx');
};

/* --- Enable sound on updates --- */
let soundEnabled = false;
document.getElementById('btnEnableSound').onclick = ()=> { soundEnabled = !soundEnabled; document.getElementById('btnEnableSound').textContent = soundEnabled ? 'Sound: ON' : 'Enable Sound'; };

/* Play short beep */
function beep(){ try{ if(!soundEnabled) return; const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); o.type='sine'; o.frequency.value=880; o.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 120); }catch(e){} }

/* Listen for new patroli entries to play sound/append mission log */
db.ref('patroli').on('child_added', snap=>{
  // snap is uid -> entries map
  const uid = snap.key; const entries = snap.val() || {};
  // For simplicity add last entry for each uid to log
  const lastKey = Object.keys(entries || {}).sort().reverse()[0];
  const last = entries[lastKey];
  if(!last) return;
  const s = document.getElementById('missionLog');
  const row = document.createElement('div'); row.className='log-item'; row.innerHTML = `<div><b>${last.officer||uid}</b> — ${new Date(last.time||Date.now()).toLocaleString()}</div><div class="small">${last.desc||''}</div>`;
  s.insertBefore(row, s.firstChild);
  beep();
});

/* --- Quick user uploader for testing (sends to /patroli + updates /live) --- */
document.getElementById('btnUpload').addEventListener('click', async ()=>{
  const f = document.getElementById('filePicker').files[0];
  const name = document.getElementById('officerName').value || ('Anon_'+Math.floor(Math.random()*999));
  if(!f) return alert('Pilih foto');
  try{
    const url = await uploadToCloudinary(f);
    // get geolocation (best effort)
    let lat=null, lon=null;
    try{ const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:7000})); lat=pos.coords.latitude; lon=pos.coords.longitude;}catch(e){ console.warn('geo fail',e); }
    const payload = { officer:name, photo:url, lat, lon, time: Date.now(), desc:'Manual upload via quick UI' };
    // push to /patroli/{uid}
    const uid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : ('anon_'+Math.random().toString(36).slice(2,6));
    await db.ref('patroli/'+uid).push(payload);
    // also update /live/{uid}
    await db.ref('live/'+uid).update({ photoUrl: url, lastGps: { lat, lon, time: Date.now() }, presence:{ officerName:name, lastSeen: Date.now() } });
    alert('Terkirim ke DB');
  }catch(e){ console.error(e); alert('Upload/GPS gagal: '+(e.message||e)); }
});

/* --- Small troubleshooting helpers --- */
console.log('Merged monitor+user script initialized. Check console for errors.');
</script>

</body>
</html>