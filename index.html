<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli ‚Äî CYBER COMMAND FINAL</title>

<!-- CDN deps -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
:root{
  --bg:#05060a; --panel:#07101a; --card:#0b1220; --muted:#9aa4b2; 
  --accent:#00e6ff; --cyber-green:#00ff41; --cyber-blue:#00e6ff; --cyber-purple:#b967ff;
}
*{box-sizing:border-box; margin:0; padding:0;}
body{
  margin:0;
  font-family:'Courier New', monospace;
  background:#000;
  color:#e6f7ff;
  overflow-x:hidden;
  position:relative;
}

/* ==================== CYBER UI EFFECTS ==================== */
.matrix-bg {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: 
    radial-gradient(circle at 20% 80%, rgba(0,255,65,0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(0,230,255,0.05) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(185,103,255,0.03) 0%, transparent 50%);
  background-color:#000;
  z-index:-2;
  opacity:0.6;
}

.cyber-grid {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background-image: 
    linear-gradient(rgba(0,255,65,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,65,0.03) 1px, transparent 1px);
  background-size:50px 50px;
  z-index:-1;
  opacity:0.3;
}

.cyber-border {
  border:1px solid var(--cyber-green);
  box-shadow:0 0 10px var(--cyber-green), inset 0 0 10px rgba(0,255,65,0.1);
}

.cyber-glow {
  box-shadow:0 0 15px var(--accent), 0 0 30px rgba(0,230,255,0.3);
}

.scan-line {
  position:relative;
  overflow:hidden;
}

.scan-line::after {
  content:'';
  position:absolute;
  top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg, transparent, var(--cyber-green), transparent);
  animation:scan 3s linear infinite;
}

@keyframes scan {
  0% { transform:translateY(0); }
  100% { transform:translateY(100vh); }
}

/* ==================== LAYOUT ==================== */
.cyber-header{
  background:linear-gradient(90deg, #000000, #001122, #000000);
  color:#fff;
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  border-bottom:2px solid var(--cyber-green);
  box-shadow:0 0 20px rgba(0,255,65,0.2);
  position:relative;
  flex-wrap:wrap;
}

.cyber-header::before {
  content:'';
  position:absolute;
  top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg, transparent, var(--cyber-green), transparent);
  animation:pulse 2s infinite;
}

@keyframes pulse {
  0%,100% { opacity:0.3; }
  50% { opacity:1; }
}

.cyber-header h1{
  margin:0;
  font-size:17px;
  color:var(--cyber-green);
  text-shadow:0 0 10px var(--cyber-green);
}

.header-controls{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.container{
  max-width:1200px;
  margin:12px auto;
  padding:10px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  border:1px solid rgba(0,230,255,0.2);
  box-shadow:0 8px 20px rgba(7,10,25,0.1);
  position:relative;
}

.card::before {
  content:'';
  position:absolute;
  top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg, transparent, var(--cyber-blue), transparent);
}

.sidebar{width:340px; min-width:260px;}

/* ==================== FORM ELEMENTS ==================== */
label{
  display:block;
  margin:8px 0 6px;
  font-weight:700;
  color:var(--accent);
  font-size:13px;
}

.form-input{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid rgba(0,230,255,0.3);
  background:rgba(0,0,0,0.5);
  color:#fff;
  font-family:'Courier New', monospace;
  font-size:12px;
  transition:all 0.3s ease;
}

.form-input:focus{
  outline:none;
  border-color:var(--cyber-green);
  box-shadow:0 0 15px rgba(0,255,65,0.3);
  background:rgba(0,0,0,0.7);
}

textarea.form-input{
  min-height:80px;
  resize:vertical;
}

/* ==================== BUTTONS ==================== */
.btn-cyber{
  background:rgba(0,0,0,0.7);
  color:var(--accent);
  padding:10px 12px;
  border-radius:6px;
  border:1px solid rgba(0,230,255,0.3);
  cursor:pointer;
  font-family:'Courier New', monospace;
  font-size:11px;
  font-weight:700;
  transition:all 0.3s ease;
  text-align:center;
  position:relative;
  overflow:hidden;
}

.btn-cyber::before{
  content:'';
  position:absolute;
  top:0; left:-100%; width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(0,230,255,0.2), transparent);
  transition:left 0.5s;
}

.btn-cyber:hover::before{
  left:100%;
}

.btn-cyber:hover{
  background:rgba(0,230,255,0.1);
  border-color:var(--accent);
  box-shadow:0 0 15px rgba(0,230,255,0.4);
  transform:translateY(-1px);
}

.btn-cyber.primary{
  background:linear-gradient(135deg, var(--accent), #0088cc);
  color:#000;
  border:none;
}

.btn-cyber.danger{
  background:linear-gradient(135deg, #ff4444, #cc0000);
  color:#fff;
  border:none;
}

.btn-cyber.ghost{
  background:transparent;
  color:var(--accent);
  border:1px solid rgba(0,230,255,0.12);
}

/* ==================== TABS ==================== */
.tabs{
  display:flex;
  gap:8px;
  margin-bottom:12px;
  flex-wrap:wrap;
}

.tab{
  padding:8px 10px;
  border-radius:10px;
  background:rgba(0,230,255,0.1);
  color:var(--accent);
  cursor:pointer;
  font-weight:700;
  font-size:12px;
  border:1px solid rgba(0,230,255,0.2);
  transition:all 0.3s ease;
}

.tab:hover{
  background:rgba(0,230,255,0.2);
  border-color:var(--accent);
}

.tab.active{
  background:var(--accent);
  color:#000;
}

/* ==================== AREAS & PHOTOS ==================== */
.areas{margin-top:12px;}
.area{
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
  border:1px solid rgba(0,230,255,0.2);
  background:linear-gradient(180deg, rgba(11,18,32,0.8), rgba(7,16,26,0.6));
  position:relative;
}

.area::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg, transparent, var(--cyber-green), transparent);
}

.area-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

.area-title{
  font-weight:800;
  font-size:16px;
  padding:6px 10px;
  border-radius:6px;
  color:#fff;
}

.photo-controls{
  display:flex;
  gap:8px;
  align-items:center;
  margin-top:8px;
  flex-wrap:wrap;
}

.photos{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

.photo-item{
  width:140px;
  height:100px;
  border-radius:8px;
  overflow:hidden;
  position:relative;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(0,230,255,0.2);
}

.photo-item img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.photo-meta{
  font-size:11px;
  color:var(--muted);
  padding:6px;
  text-align:left;
}

.icon-btn{
  background:rgba(255,255,255,0.1);
  border-radius:6px;
  padding:6px;
  border:1px solid rgba(0,230,255,0.3);
  cursor:pointer;
  color:var(--accent);
  transition:all 0.3s ease;
}

.icon-btn:hover{
  background:rgba(0,230,255,0.2);
  border-color:var(--accent);
}

/* ==================== SIGNATURE ==================== */
.signature-canvas{
  border:2px solid var(--cyber-green);
  border-radius:8px;
  touch-action:none;
  background:#ffffff !important;
  box-shadow:0 0 15px rgba(0,255,65,0.3);
  display:block;
  width:100%;
}

.sig-preview{
  width:160px;
  height:70px;
  border:1px solid rgba(0,230,255,0.3);
  border-radius:6px;
  overflow:hidden;
  background:rgba(255,255,255,0.1);
}

/* ==================== CHAT MODAL ==================== */
.chat-modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.95);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
  backdrop-filter:blur(5px);
}

.chat-modal-content{
  background:linear-gradient(135deg, #0b1220, #1a2b3c);
  border:2px solid var(--cyber-green);
  border-radius:10px;
  width:90%;
  max-width:500px;
  height:80vh;
  max-height:600px;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 40px rgba(0,255,65,0.3);
  position:relative;
}

.chat-modal-content::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background:linear-gradient(45deg, transparent 60%, rgba(0,255,65,0.1) 100%);
  border-radius:8px;
  pointer-events:none;
}

.chat-header{
  padding:15px;
  border-bottom:1px solid rgba(0,230,255,0.3);
  background:rgba(0,0,0,0.5);
  border-radius:10px 10px 0 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chat-header h3{
  color:var(--cyber-green);
  margin:0;
  text-shadow:0 0 10px var(--cyber-green);
}

.chat-messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.chat-message{
  display:flex;
  gap:10px;
  padding:10px;
  border-radius:8px;
  background:rgba(0,0,0,0.3);
  border-left:3px solid var(--cyber-blue);
  animation:slideIn 0.3s ease;
}

@keyframes slideIn {
  from{ opacity:0; transform:translateX(-10px); }
  to{ opacity:1; transform:translateX(0); }
}

.chat-avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid var(--cyber-blue);
  cursor:pointer;
}

.chat-content{
  flex:1;
}

.chat-sender{
  font-weight:bold;
  color:var(--cyber-blue);
  font-size:12px;
  margin-bottom:4px;
}

.chat-text{
  color:#e6f7ff;
  font-size:12px;
  word-break:break-word;
}

.chat-time{
  font-size:10px;
  color:var(--muted);
  margin-top:4px;
}

.chat-input-area{
  padding:15px;
  border-top:1px solid rgba(0,230,255,0.3);
  background:rgba(0,0,0,0.5);
  border-radius:0 0 10px 10px;
  display:flex;
  gap:8px;
}

.chat-input{
  flex:1;
  padding:10px;
  border:1px solid rgba(0,230,255,0.3);
  background:rgba(0,0,0,0.5);
  color:#fff;
  border-radius:6px;
  font-family:'Courier New', monospace;
  font-size:12px;
}

.chat-input:focus{
  outline:none;
  border-color:var(--cyber-green);
  box-shadow:0 0 10px rgba(0,255,65,0.3);
}

/* ==================== UTILITIES ==================== */
.hidden{display:none !important;}
.muted{color:var(--muted); font-size:12px;}
.note{font-size:12px; color:var(--muted); margin-top:8px;}

.status-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
}

.status-online{
  background:#00ff41;
  box-shadow:0 0 8px #00ff41;
  animation:pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%,100% { opacity:1; }
  50% { opacity:0.5; }
}

.status-offline{
  background:#ff4444;
  box-shadow:0 0 8px #ff4444;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width:900px){
  .sidebar{width:100%;}
  .container{padding:8px;}
  .cyber-header{flex-direction:column; gap:12px;}
  .header-controls{justify-content:center;}
}

@media (max-width:768px){
  .chat-modal-content{
    width:95%;
    height:90vh;
  }
  
  .photo-item{
    width:120px;
    height:85px;
  }
}

@media (max-width:480px){
  .tabs{justify-content:center;}
  .photo-controls{justify-content:center;}
  .photo-item{
    width:100px;
    height:75px;
  }
}
</style>
</head>
<body>
<!-- Cyber Background Effects -->
<div class="matrix-bg"></div>
<div class="cyber-grid"></div>

<header class="cyber-header scan-line">
  <h1>üöÄ PATROLI CYBER COMMAND</h1>
  <div class="header-controls">
    <div id="modeDisplay" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-weight:700">Mode: User</div>
    <button id="btnToggleMode" class="btn-cyber ghost">Masuk Admin</button>
    <button id="btnChat" class="btn-cyber primary">üí¨ CHAT</button>
    <span id="gpsStatus" class="muted">GPS: belum</span>
    <button id="btnStartGPS" class="btn-cyber">üìç START GPS</button>
    <button id="btnGeneratePDF" class="btn-cyber">üìÑ GENERATE PDF</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar">
    <div class="tabs">
      <div class="tab active" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
      <div class="tab" id="tabFotoProfil">Foto Profil</div>
      <div class="tab" id="tabDeep">DEEP CLEAN</div>
    </div>

    <div id="areaTab">
      <label>Nama Petugas</label>
      <input id="officerName" type="text" class="form-input" placeholder="Nama petugas...">
      <label>Shift</label>
      <input id="shift" type="text" class="form-input" placeholder="Contoh: Malam">
      <label>Tanggal</label>
      <input id="date" type="text" class="form-input" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">‚Äî</span></div>
      <hr style="margin:10px 0;border-color:rgba(0,230,255,0.3)">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" class="form-input" placeholder="Nama area (manual)...">
      <input id="newAreaDetail" type="text" class="form-input" placeholder="Detail lokasi (opsional)..." style="margin-top:8px">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn-cyber">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn-cyber ghost">Scan QR (kamera)</button>
      </div>

      <div style="margin-top:12px" class="note">User hanya camera; Admin camera + gallery.</div>

      <div style="margin-top:12px" class="login-box">
        <div style="font-weight:700;margin-bottom:8px;color:var(--accent)">Admin Login</div>
        <input id="adminPass" type="password" class="form-input" placeholder="Password admin...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLogin" class="btn-cyber">Login</button>
          <button id="btnLogout" class="btn-cyber danger" style="display:none">Logout</button>
        </div>
      </div>
    </div>

    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Unlimited)</label>
      <div id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Manual (JSON)</label>
      <input id="qrAreaName" type="text" class="form-input" placeholder="Nama Area (contoh: AREA SELATAN)">
      <input id="qrAreaDetail" type="text" class="form-input" placeholder="Detail lokasi (contoh: PINTU LOBBY PERTAMA)" style="margin-top:8px">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnGenerateQRManual" class="btn-cyber">Generate QR (JSON)</button>
        <button id="btnSaveCheckpoint" class="btn-cyber ghost">Simpan ke Daftar</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <canvas id="qrCanvasManual" style="border:1px solid rgba(0,230,255,0.3);background:rgba(255,255,255,0.1);border-radius:6px"></canvas>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="btnDownloadQRManual" class="btn-cyber">Download QR</button>
          <button id="btnCopyQRDataManual" class="btn-cyber ghost">Copy QR DataURL</button>
          <button id="btnCopyQRContentManual" class="btn-cyber ghost">Copy QR Content</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Scanner (kamera langsung)</label>
        <video id="video" style="width:100%;height:220px;background:#000;border-radius:8px;object-fit:cover;border:1px solid rgba(0,230,255,0.3)" autoplay muted playsinline></video>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="btnStartScan" class="btn-cyber ghost">Start Scan Camera</button>
          <button id="btnStopScan" class="btn-cyber ghost">Stop Scan</button>
          <input id="fileScanInput" type="file" accept="image/*" style="display:none">
          <button id="btnFileScan" class="btn-cyber ghost">Scan dari File/Galeri</button>
        </div>
        <div id="scanResult" class="muted" style="margin-top:8px">Hasil scan: ‚Äî</div>
      </div>
    </div>

    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" class="form-input" placeholder="Contoh: SEI JKT11">
      <div class="note">Isi lokasi ini akan tampil di cover PDF (override GPS jika diisi).</div>
    </div>

    <div id="fotoProfilTab" class="hidden">
      <h3 style="color:var(--cyber-green);margin-bottom:8px">FOTO PROFIL COVER</h3>
      <p style="color:var(--muted);font-size:12px">Foto ini akan ditampilkan di halaman cover PDF</p>
      
      <div id="profilePhotoPreview" style="width:100%;max-height:200px;object-fit:contain;border-radius:8px;border:2px dashed rgba(0,230,255,0.3);margin-top:8px;display:none"></div>
      
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="btnTakeProfilePhoto" class="btn-cyber">Ambil Foto (Kamera)</button>
        <button id="btnUploadProfilePhoto" class="btn-cyber ghost" style="display:none">Pilih dari Galeri</button>
      </div>
      
      <div class="note" style="margin-top:8px">
        <strong>Preview:</strong> Foto profil akan ditampilkan di sisi kanan cover PDF
      </div>
      
      <button id="btnRemoveProfilePhoto" class="btn-cyber danger" style="margin-top:8px;display:none">Hapus Foto Profil</button>
    </div>

    <div id="deepTab" class="hidden">
      <h3 style="color:var(--cyber-green);margin-bottom:8px">DEEP CLEAN-UP</h3>
      <p style="color:var(--muted);font-size:12px">Hapus <strong>SEMUA DATA</strong> termasuk semua area, foto, logo, tanda tangan, password runtime. Aplikasi akan kembali seperti baru.</p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnDeepClean" class="btn-cyber danger">Deep Clean (OK)</button>
        <button id="btnDeepCancel" class="btn-cyber ghost">Batal</button>
      </div>
    </div>

    <hr style="margin:12px 0;border-color:rgba(0,230,255,0.3)">
    <div class="note">Host via HTTPS (GitHub Pages) dan tes di Chrome Android untuk hasil terbaik.</div>
  </aside>

  <main class="card" style="flex:1 1 820px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab active" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="viewAreas">
      <div id="areasContainer" class="areas"></div>
    </section>

    <section id="viewSignature" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" class="form-input" placeholder="Nama pada tanda tangan...">
      <div style="margin-top:8px">
        <canvas id="sigCanvas" class="signature-canvas" width="700" height="140"></canvas>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnClearSig" class="btn-cyber danger">Hapus</button>
        <button id="btnSaveSig" class="btn-cyber">Simpan Tanda Tangan</button>
        <div style="margin-left:12px">
          <div class="muted">Preview:</div>
          <div id="sigPreview" class="sig-preview"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Chat Modal -->
<div id="chatModal" class="chat-modal">
  <div class="chat-modal-content">
    <div class="chat-header">
      <h3>üí¨ REALTIME CHAT COMMAND</h3>
      <button id="btnCloseChat" class="btn-cyber danger" style="padding:6px 10px">‚úï CLOSE</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input id="chatInput" type="text" class="chat-input" placeholder="Ketik pesan...">
      <button id="btnSendChat" class="btn-cyber primary">SEND</button>
    </div>
  </div>
</div>

<!-- Deep Clean Modal -->
<div id="modalBackdrop" class="chat-modal">
  <div class="chat-modal-content" style="max-width:400px;height:auto">
    <div class="chat-header">
      <h3>üßπ DEEP CLEAN-UP</h3>
    </div>
    <div style="padding:20px">
      <p style="color:var(--muted);margin-bottom:15px;font-size:13px">Hapus <strong>SEMUA DATA</strong> termasuk: semua area patroli, semua foto, logo, tanda tangan, password akses. Aplikasi akan kembali seperti baru! Yakin ingin melanjutkan?</p>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="modalCancel" class="btn-cyber ghost">Batal</button>
        <button id="modalOk" class="btn-cyber danger">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
/* PATROLI CYBER COMMAND - FULL INTEGRATION */
(function(){
  const $ = s => document.querySelector(s);
  const uid = (p='id')=> p+'-'+Math.random().toString(36).slice(2,9);
  const revoke = url => { try{ if(url) URL.revokeObjectURL(url);}catch(e){} };

  const state = {
    isAdmin:false,
    adminPassword: window.__patrol_admin_password ?? 'raja123',
    areas:[],
    checkpoints:[],
    gpsPath:[],
    signature:null,
    profilePhoto: null,
    chatMessages: []
  };

  const refs = {
    modeDisplay: $('#modeDisplay'), btnToggleMode: $('#btnToggleMode'),
    btnStartGPS: $('#btnStartGPS'), gpsStatus: $('#gpsStatus'), coords: $('#coords'),
    btnAddArea: $('#btnAddArea'), newAreaName: $('#newAreaName'), newAreaDetail: $('#newAreaDetail'), areasContainer: $('#areasContainer'),
    tabAreas: $('#tabAreas'), tabCheckpoint: $('#tabCheckpoint'), tabLokasi: $('#tabLokasi'), tabFotoProfil: $('#tabFotoProfil'), tabDeep: $('#tabDeep'),
    areaTab: $('#areaTab'), checkpointTab: $('#checkpointTab'), lokasiTab: $('#lokasiTab'), fotoProfilTab: $('#fotoProfilTab'), deepTab: $('#deepTab'),
    btnScanAreaQR: $('#btnScanAreaQR'),
    btnGenerateQRManual: $('#btnGenerateQRManual'), qrCanvasManual: $('#qrCanvasManual'), btnDownloadQRManual: $('#btnDownloadQRManual'),
    btnCopyQRDataManual: $('#btnCopyQRDataManual'), btnCopyQRContentManual: $('#btnCopyQRContentManual'), btnSaveCheckpoint: $('#btnSaveCheckpoint'),
    qrAreaName: $('#qrAreaName'), qrAreaDetail: $('#qrAreaDetail'),
    btnLogin: $('#btnLogin'), btnLogout: $('#btnLogout'), adminPass: $('#adminPass'),
    btnGeneratePDF: $('#btnGeneratePDF'),
    tabViewAreas: $('#tabViewAreas'), tabSignature: $('#tabSignature'), viewAreas: $('#viewAreas'), viewSignature: $('#viewSignature'),
    sigCanvas: $('#sigCanvas'), btnClearSig: $('#btnClearSig'), btnSaveSig: $('#btnSaveSig'), sigPreview: $('#sigPreview'), sigName: $('#sigName'),
    btnDeepClean: $('#btnDeepClean'), btnDeepCancel: $('#btnDeepCancel'),
    modalBackdrop: $('#modalBackdrop'), modalOk: $('#modalOk'), modalCancel: $('#modalCancel'),
    manualLokasi: $('#manualLokasi'), officerName: $('#officerName'), shift: $('#shift'), date: $('#date'),
    video: $('#video'), btnStartScan: $('#btnStartScan'), btnStopScan: $('#btnStopScan'), scanResult: $('#scanResult'),
    fileScanInput: $('#fileScanInput'), btnFileScan: $('#btnFileScan'), qrList: $('#qrList'),
    btnTakeProfilePhoto: $('#btnTakeProfilePhoto'), btnUploadProfilePhoto: $('#btnUploadProfilePhoto'),
    btnRemoveProfilePhoto: $('#btnRemoveProfilePhoto'), profilePhotoPreview: $('#profilePhotoPreview'),
    // Chat elements
    btnChat: $('#btnChat'), chatModal: $('#chatModal'), btnCloseChat: $('#btnCloseChat'),
    chatMessages: $('#chatMessages'), chatInput: $('#chatInput'), btnSendChat: $('#btnSendChat')
  };

  // ==================== FIREBASE CONFIG ====================
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
    authDomain: "silitpitik7373.firebaseapp.com",
    databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
    projectId: "silitpitik7373",
    storageBucket: "silitpitik7373.appspot.com",
    messagingSenderId: "314430704796",
    appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
  };

  // Initialize Firebase
  if(!window.firebase || !firebase.apps || !firebase.apps.length) {
    firebase.initializeApp(FIREBASE_CONFIG);
  }
  const db = firebase.database();
  firebase.auth().signInAnonymously().catch(e => console.warn('Auth error:', e));

  // ==================== CHAT SYSTEM ====================
  const chatRef = db.ref('chat/global');
  
  function setupChatSystem() {
    // Open chat modal
    refs.btnChat.addEventListener('click', () => {
      refs.chatModal.style.display = 'flex';
      refs.chatInput.focus();
    });
    
    // Close chat modal
    refs.btnCloseChat.addEventListener('click', () => {
      refs.chatModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    refs.chatModal.addEventListener('click', (e) => {
      if (e.target === refs.chatModal) {
        refs.chatModal.style.display = 'none';
      }
    });
    
    // Send message
    refs.btnSendChat.addEventListener('click', sendChatMessage);
    refs.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });
    
    // Listen for messages
    chatRef.limitToLast(50).on('child_added', (snapshot) => {
      const message = snapshot.val();
      if (message) addChatMessage(message);
    });
  }
  
  function sendChatMessage() {
    const messageText = refs.chatInput.value.trim();
    if (!messageText) return;
    
    const user = firebase.auth().currentUser;
    const uid = user ? user.uid : 'patrol_' + Math.random().toString(36).slice(2,9);
    const officerName = refs.officerName.value || 'Petugas';
    const profilePhoto = state.profilePhoto ? state.profilePhoto.url : getDefaultAvatar(officerName);
    
    chatRef.push({
      uid: uid,
      name: officerName,
      text: messageText,
      photo: profilePhoto,
      time: Date.now()
    });
    
    refs.chatInput.value = '';
  }
  
  function addChatMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message';
    
    const time = new Date(message.time || Date.now());
    const timeString = time.toLocaleTimeString('id-ID', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    const avatarUrl = message.photo || getDefaultAvatar(message.name);
    
    messageDiv.innerHTML = `
      <img src="${avatarUrl}" class="chat-avatar" 
           onclick="showProfileModal('${avatarUrl}', '${message.name}')"
           alt="${message.name}">
      <div class="chat-content">
        <div class="chat-sender">${message.name}</div>
        <div class="chat-text">${message.text}</div>
        <div class="chat-time">${timeString}</div>
      </div>
    `;
    
    refs.chatMessages.appendChild(messageDiv);
    refs.chatMessages.scrollTop = refs.chatMessages.scrollHeight;
  }
  
  function getDefaultAvatar(name) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0e1a2f&color=00e6ff&size=150&bold=true`;
  }
  
  // ==================== PROFILE MODAL ====================
  window.showProfileModal = function(photoUrl, name) {
    const modal = document.createElement('div');
    modal.className = 'chat-modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="chat-modal-content" style="max-width:300px;height:auto;text-align:center">
        <div class="chat-header">
          <h3>üëÆ PROFIL PETUGAS</h3>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="btn-cyber danger" style="padding:6px 10px">‚úï</button>
        </div>
        <div style="padding:20px">
          <img src="${photoUrl}" 
               style="width:120px;height:120px;object-fit:cover;border-radius:8px;border:3px solid var(--accent);box-shadow:0 0 30px rgba(0,230,255,0.7);margin-bottom:15px">
          <div style="color:var(--cyber-blue);font-weight:bold;font-size:16px">${name}</div>
          <div style="color:var(--muted);font-size:12px;margin-top:5px">Petugas Patroli Aktif</div>
        </div>
      </div>
    `;
    
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
    document.body.appendChild(modal);
  };

  // ==================== CORE FUNCTIONS ====================
  function colorForId(id){ let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); return 'hsl('+ (Math.abs(h)%360) +',68%,36%)'; }
  function colorForIdRgb(id){ let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); const hue = Math.abs(h)%360; return hslToRgb(hue/360,0.7,0.4); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; }else{ const hue2rgb=(p,q,t)=>{ if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}; const q = l<0.5? l*(1+s): l + s - l*s; const p = 2*l - q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} return [Math.round(r*255),Math.round(g*255),Math.round(b*255)]; }

  function updateModeUI(){ 
    refs.modeDisplay.textContent = 'Mode: ' + (state.isAdmin ? 'Admin' : 'User'); 
    refs.btnToggleMode.textContent = state.isAdmin ? 'Masuk User' : 'Masuk Admin'; 
    refs.btnLogout.style.display = state.isAdmin ? 'inline-block' : 'none'; 
    refs.btnLogin.style.display = state.isAdmin ? 'none' : 'inline-block'; 
    refs.btnUploadProfilePhoto.style.display = state.isAdmin ? 'inline-block' : 'none';
    renderAreas(); 
    renderCheckpointList(); 
    renderProfilePhoto(); 
  }

  refs.btnToggleMode.addEventListener('click', ()=>{ if(!state.isAdmin){ const p = prompt('Password Admin:'); if(p===null) return; if(p === state.adminPassword){ state.isAdmin = true; updateModeUI(); alert('Admin login'); } else alert('Password salah'); } else { state.isAdmin = false; updateModeUI(); alert('Mode User aktif'); } });
  refs.btnLogin.addEventListener('click', ()=>{ const p = refs.adminPass.value||''; if(p === state.adminPassword){ state.isAdmin = true; refs.adminPass.value=''; updateModeUI(); alert('Admin login'); } else alert('Password salah'); });
  refs.btnLogout.addEventListener('click', ()=>{ state.isAdmin = false; updateModeUI(); alert('Logout'); });

  let watchId = null;
  refs.btnStartGPS.addEventListener('click', ()=>{ 
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; } 
    refs.btnStartGPS.style.display='none'; 
    refs.gpsStatus.textContent='GPS: aktif'; 
    watchId = navigator.geolocation.watchPosition(
      pos=>{ 
        const lat = pos.coords.latitude, lon = pos.coords.longitude, ts = pos.timestamp; 
        refs.coords.textContent = lat.toFixed(6) + ', ' + lon.toFixed(6) + ' @ ' + new Date(ts).toLocaleTimeString(); 
        state.gpsPath.push({lat,lon,timestamp:ts}); 
        
        // Update Firebase live tracking
        const uid = (firebase.auth().currentUser && firebase.auth().currentUser.uid) || getLocalUid();
        const officerName = refs.officerName.value || 'Petugas';
        db.ref('live').child(uid).update({ 
          lastGps: { lat: lat, lon: lon, time: ts }, 
          presence: { officerName: officerName, lastSeen: ts } 
        });
      }, 
      err=>{ console.warn(err); refs.gpsStatus.textContent='GPS: error'; }, 
      {enableHighAccuracy:true,maximumAge:2000,timeout:8000}
    ); 
  });

  // Tab navigation
  refs.tabAreas.addEventListener('click', ()=>{ setActiveTab('areaTab'); });
  refs.tabCheckpoint.addEventListener('click', ()=>{ setActiveTab('checkpointTab'); });
  refs.tabLokasi.addEventListener('click', ()=>{ setActiveTab('lokasiTab'); });
  refs.tabFotoProfil.addEventListener('click', ()=>{ setActiveTab('fotoProfilTab'); });
  refs.tabDeep.addEventListener('click', ()=>{ setActiveTab('deepTab'); });
  refs.tabViewAreas.addEventListener('click', ()=>{ setActiveView('viewAreas'); });
  refs.tabSignature.addEventListener('click', ()=>{ setActiveView('viewSignature'); });

  function setActiveTab(tabName) {
    [refs.areaTab, refs.checkpointTab, refs.lokasiTab, refs.fotoProfilTab, refs.deepTab].forEach(tab => {
      tab.classList.add('hidden');
    });
    refs[tabName].classList.remove('hidden');
    
    // Update tab active state
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
  }

  function setActiveView(viewName) {
    [refs.viewAreas, refs.viewSignature].forEach(view => {
      view.classList.add('hidden');
    });
    refs[viewName].classList.remove('hidden');
    
    // Update view tab active state
    document.querySelectorAll('#tabViewAreas, #tabSignature').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
  }

  refs.btnAddArea.addEventListener('click', ()=>{ addArea(refs.newAreaName.value.trim()||undefined, refs.newAreaDetail.value.trim()||undefined); refs.newAreaName.value=''; refs.newAreaDetail.value=''; });
  function addArea(name, detail){
    const id = uid('area'); 
    state.areas.push({
      id,
      name: name || ('Area '+(state.areas.length+1)), 
      detail: detail||'', 
      description:'', 
      photos:[]
    }); 
    renderAreas();
  }

  function renderAreas(){
    refs.areasContainer.innerHTML = '';
    state.areas.forEach(area=>{
      const wrapper = document.createElement('div'); wrapper.className='area';
      const h = document.createElement('div'); h.className='area-header';
      const title = document.createElement('div'); title.className='area-title'; title.textContent = area.name + (area.detail ? ' ‚Äî ' + area.detail : ''); title.style.background = colorForId(area.id);
      h.appendChild(title);
      const actions = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='<i class="fa fa-pen"></i>'; editBtn.title='Edit nama area';
      editBtn.onclick = ()=>{ const nv = prompt('Edit nama area:', area.name); if(nv!==null){ area.name = nv; renderAreas(); } };
      const qrBtn = document.createElement('button'); qrBtn.className='icon-btn'; qrBtn.innerHTML='<i class="fa fa-qrcode"></i>'; qrBtn.title='Scan QR to fill area';
      qrBtn.onclick = async ()=>{ try{ const content = await startScanOne(false); if(!content) return; try{ const p = JSON.parse(content); if(p && p.area){ area.name = p.area; area.detail = p.detail||area.detail; renderAreas(); alert('Area terisi dari QR'); return; } }catch(e){ area.name = content; renderAreas(); alert('Area terisi: '+content); } } catch(e){ alert('Scan QR gagal: '+(e.message||e)); } };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML='<i class="fa fa-trash" style="color:#ff4444"></i>'; delBtn.title='Hapus area';
      delBtn.onclick = ()=>{ if(confirm('Hapus area & semua fotonya?')){ area.photos.forEach(p=>revoke(p.url)); state.areas = state.areas.filter(x=>x.id!==area.id); renderAreas(); } };
      actions.appendChild(editBtn); actions.appendChild(qrBtn); actions.appendChild(delBtn);
      h.appendChild(actions); wrapper.appendChild(h);

      const pc = document.createElement('div'); pc.className='photo-controls';
      
      // USER: Only camera | ADMIN: Camera + gallery
      if(state.isAdmin){
        const galBtn = document.createElement('button'); galBtn.className='btn-cyber ghost'; galBtn.textContent='Pilih dari Galeri (multiple)';
        galBtn.onclick = async ()=>{ const r = await createFileInput(true, true); await handleFiles(area.id,r.files,r.pos); };
        const camBtn = document.createElement('button'); camBtn.className='btn-cyber ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput(true, false); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(galBtn); pc.appendChild(camBtn);
      } else {
        const camBtn = document.createElement('button'); camBtn.className='btn-cyber ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput(false, false); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(camBtn);
      }
      wrapper.appendChild(pc);

      const photosWrap = document.createElement('div'); photosWrap.className='photos';
      area.photos.forEach(p=>{
        const col = document.createElement('div'); col.style.width='170px';
        const photoItem = document.createElement('div'); photoItem.className='photo-item';
        const img = document.createElement('img'); img.src = p.url; photoItem.appendChild(img);
        const actionWrap = document.createElement('div'); actionWrap.style.position='absolute'; actionWrap.style.left='6px'; actionWrap.style.bottom='6px'; actionWrap.style.display='flex'; actionWrap.style.gap='6px';
        const del = document.createElement('button'); del.className='icon-btn'; del.innerHTML='<i class="fa fa-trash" style="color:#ff4444"></i>';
        del.onclick = ()=>{ if(confirm('Hapus foto?')){ area.photos = area.photos.filter(pp=>pp.id!==p.id); revoke(p.url); renderAreas(); } };
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.innerHTML='<i class="fa fa-pen" style="color:#00e6ff"></i>';
        edit.onclick = ()=>{ const v = prompt('Deskripsi (tanpa batas):', p.desc||''); if(v!==null){ p.desc = v; renderAreas(); } };
        actionWrap.appendChild(del); actionWrap.appendChild(edit); photoItem.appendChild(actionWrap);
        const meta = document.createElement('div'); meta.className='photo-meta';
        meta.innerHTML = `<div style="font-weight:700;color:#e6f7ff">${p.desc || '(klik pensil untuk deskripsi)'}</div>
          <div style="font-size:11px;color:var(--muted)">${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>${p.ts? new Date(p.ts).toLocaleString(): ''}</div>`;
        col.appendChild(photoItem); col.appendChild(meta); photosWrap.appendChild(col);
      });
      wrapper.appendChild(photosWrap);

      const ta = document.createElement('textarea'); ta.className='form-input'; ta.placeholder='Deskripsi area...'; ta.value = area.description || ''; ta.oninput = ()=> area.description = ta.value;
      const saveBtn = document.createElement('button'); saveBtn.className='btn-cyber'; saveBtn.textContent='Simpan Deskripsi Area'; saveBtn.style.marginTop='8px'; saveBtn.onclick = ()=> alert('Deskripsi area disimpan');
      wrapper.appendChild(ta); wrapper.appendChild(saveBtn);

      refs.areasContainer.appendChild(wrapper);
    });
  }

  function createFileInput(isAdmin, allowMultiple){
    return new Promise(resolve=>{
      function getPos(cb){ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>cb({lat:p.coords.latitude,lon:p.coords.longitude,ts:p.timestamp}), ()=>cb(null), {enableHighAccuracy:true,timeout:4000}); } else cb(null); }
      getPos(function(pos){
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; 
        
        if (!isAdmin) {
          // USER: Force camera only
          inp.setAttribute('capture', 'environment');
          inp.multiple = false;
        } else {
          // ADMIN: Browser choice (camera/gallery)
          inp.multiple = allowMultiple;
        }
        
        inp.style.display='none'; document.body.appendChild(inp);
        inp.addEventListener('change', e=>{ const files = Array.from(e.target.files || []); try{ document.body.removeChild(inp);}catch(e){}; resolve({files,pos}); });
        inp.click();
        setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; resolve({files:[],pos}); },30000);
      });
    });
  }

  async function handleFiles(areaId, files, pos){
    const area = state.areas.find(a=>a.id===areaId); if(!area) return;
    for(const f of files){
      const id = uid('photo'); const url = URL.createObjectURL(f);
      let lat=null, lon=null, ts=null;
      if(pos){ lat = pos.lat; lon = pos.lon; ts = pos.ts; }
      else if(state.gpsPath.length){ const g = state.gpsPath[state.gpsPath.length-1]; lat=g.lat; lon=g.lon; ts=g.timestamp; }
      area.photos.push({id,file:f,url,desc:'',lat,lon,ts});
      
      // Upload to Cloudinary and Firebase
      try {
        const uploadedUrl = await uploadToCloudinary(f);
        const uid = (firebase.auth().currentUser && firebase.auth().currentUser.uid) || getLocalUid();
        const officerName = refs.officerName.value || 'Petugas';
        
        await db.ref('patroli').child(uid).push({
          photo: uploadedUrl,
          areaId: areaId,
          lat: lat,
          lon: lon,
          desc: '',
          time: ts || Date.now(),
          officer: officerName
        });
      } catch(e) {
        console.warn('Cloudinary upload failed', e);
      }
    }
    renderAreas();
  }

  // Profile Photo Functions
  function renderProfilePhoto() {
    if (state.profilePhoto) {
      refs.profilePhotoPreview.style.display = 'block';
      refs.profilePhotoPreview.innerHTML = `<img src="${state.profilePhoto.url}" style="width:100%;height:100%;object-fit:contain;border-radius:6px">`;
      refs.btnRemoveProfilePhoto.style.display = 'inline-block';
    } else {
      refs.profilePhotoPreview.style.display = 'none';
      refs.btnRemoveProfilePhoto.style.display = 'none';
    }
  }

  refs.btnTakeProfilePhoto.addEventListener('click', async () => {
    try {
      const result = await createFileInput(state.isAdmin, false);
      if (result.files.length > 0) {
        const file = result.files[0];
        const url = URL.createObjectURL(file);
        state.profilePhoto = { file, url };
        renderProfilePhoto();
        alert('Foto profil berhasil diambil!');
      }
    } catch (e) {
      alert('Gagal mengambil foto: ' + e.message);
    }
  });

  refs.btnUploadProfilePhoto.addEventListener('click', async () => {
    try {
      const result = await createFileInput(true, false); // Admin always has gallery access
      if (result.files.length > 0) {
        const file = result.files[0];
        const url = URL.createObjectURL(file);
        state.profilePhoto = { file, url };
        renderProfilePhoto();
        alert('Foto profil berhasil diupload!');
      }
    } catch (e) {
      alert('Gagal upload foto: ' + e.message);
    }
  });

  refs.btnRemoveProfilePhoto.addEventListener('click', () => {
    if (state.profilePhoto) {
      revoke(state.profilePhoto.url);
      state.profilePhoto = null;
      renderProfilePhoto();
      alert('Foto profil dihapus!');
    }
  });

  // QR System
  const qrManual = new QRious({ element: refs.qrCanvasManual, size: 220, value: '' });
  function buildQRJson(area, detail){ const a=(area||'').trim(); const d=(detail||'').trim(); return JSON.stringify({area:a,detail:d}); }
  refs.btnGenerateQRManual.addEventListener('click', ()=>{ const content = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); if(!refs.qrAreaName.value.trim() && !refs.qrAreaDetail.value.trim()){ alert('Isi area atau detail'); return; } qrManual.set({ value: content, size: 300 }); try{ navigator.clipboard.writeText(content); }catch(e){} alert('QR JSON dibuat & disalin (opsional)'); });
  refs.btnDownloadQRManual.addEventListener('click', ()=>{ try{ const dataUrl = qrManual.toDataURL('image/png'); const a = document.createElement('a'); a.href = dataUrl; a.download = 'checkpoint_json_'+Date.now()+'.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); }catch(e){ alert('Download QR gagal'); } });
  refs.btnCopyQRDataManual.addEventListener('click', ()=>{ try{ const d = qrManual.toDataURL('image/png'); navigator.clipboard.writeText(d).then(()=>alert('DataURL QR disalin')); }catch(e){ alert('Copy fail'); } });
  refs.btnCopyQRContentManual.addEventListener('click', ()=>{ const c = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); navigator.clipboard.writeText(c).then(()=>alert('Content disalin')); });

  refs.btnSaveCheckpoint.addEventListener('click', ()=>{ const area=(refs.qrAreaName.value||'').trim(); const detail=(refs.qrAreaDetail.value||'').trim(); if(!area && !detail) return alert('Isi area atau detail'); const content=buildQRJson(area,detail); const id=uid('cp'); state.checkpoints.push({id,area,detail,content}); refs.qrAreaName.value=''; refs.qrAreaDetail.value=''; qrManual.set({ value:'' }); renderCheckpointList(); alert('Checkpoint disimpan'); });

  function renderCheckpointList(){ refs.qrList.innerHTML=''; state.checkpoints.forEach(cp=>{ const row = document.createElement('div'); row.className='qr-row'; row.innerHTML = `<div style="flex:1"><strong style="color:var(--accent)">${cp.area||'(tanpa nama)'}</strong><div class="small" style="color:var(--muted)">${cp.content}</div></div>`; const gen = document.createElement('button'); gen.className='btn-cyber'; gen.textContent='Preview QR'; gen.onclick=()=>{ qrManual.set({ value: cp.content, size:300 }); refs.qrAreaName.value = cp.area; refs.qrAreaDetail.value = cp.detail; }; const copy = document.createElement('button'); copy.className='btn-cyber ghost'; copy.textContent='Copy'; copy.onclick = ()=> navigator.clipboard.writeText(cp.content).then(()=>alert('Copied')); const dl = document.createElement('button'); dl.className='btn-cyber ghost'; dl.textContent='Download'; dl.onclick = ()=>{ try{ const tmp = new QRious({ value: cp.content, size:300 }); const dataUrl = tmp.toDataURL('image/png'); const a = document.createElement('a'); a.href = dataUrl; a.download = 'checkpoint_json_'+cp.id+'.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); }catch(e){ alert('Download fail'); } }; const del = document.createElement('button'); del.className='btn-cyber danger'; del.textContent='Hapus'; del.onclick=()=>{ if(confirm('Hapus checkpoint?')){ state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id); renderCheckpointList(); } }; row.appendChild(gen); row.appendChild(copy); row.appendChild(dl); row.appendChild(del); refs.qrList.appendChild(row); }); }

  // Camera scan with jsQR
  let scanning=false, streamRef=null;
  const video = refs.video;
  const canvasForScan = document.createElement('canvas'), ctxForScan = canvasForScan.getContext('2d');

  async function startCameraScan(){
    if(scanning) return;
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      streamRef = stream;
      video.srcObject = stream;
      await video.play();
      scanning=true; tickScan();
    }catch(err){ console.error(err); alert('Tidak bisa akses kamera: '+(err.message||err)); scanning=false; }
  }
  async function stopCameraScan(){ scanning=false; if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; } try{ video.pause(); video.srcObject=null; }catch(e){} }
  function tickScan(){
    if(!scanning) return;
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      const vw=video.videoWidth, vh=video.videoHeight;
      canvasForScan.width=vw; canvasForScan.height=vh;
      ctxForScan.drawImage(video,0,0,vw,vh);
      const imgData = ctxForScan.getImageData(0,0,vw,vh);
      const code = jsQR(imgData.data,imgData.width,imgData.height);
      if(code){ refs.scanResult.textContent = 'Hasil scan: ' + code.data; stopCameraScan(); try{ const p = JSON.parse(code.data); refs.qrAreaName.value = p.area || ''; refs.qrAreaDetail.value = p.detail || ''; alert('QR JSON terbaca'); }catch(e){ refs.qrAreaName.value = code.data; alert('QR text terbaca'); } return; } else { refs.scanResult.textContent = 'Hasil scan: tidak terdeteksi'; }
    }
    requestAnimationFrame(tickScan);
  }
  refs.btnStartScan.addEventListener('click', ()=> startCameraScan());
  refs.btnStopScan.addEventListener('click', ()=> stopCameraScan());
  refs.btnFileScan.addEventListener('click', ()=> refs.fileScanInput.click());
  refs.fileScanInput.addEventListener('change', async (e)=>{ const f = e.target.files && e.target.files[0]; if(!f) return; const img = new Image(); img.onload = ()=>{ canvasForScan.width=img.width; canvasForScan.height=img.height; ctxForScan.drawImage(img,0,0); const d = ctxForScan.getImageData(0,0,canvasForScan.width,canvasForScan.height); const code = jsQR(d.data,d.width,d.height); if(code){ refs.scanResult.textContent = 'Hasil scan: '+code.data; try{ const p = JSON.parse(code.data); refs.qrAreaName.value=p.area||''; refs.qrAreaDetail.value=p.detail||''; alert('QR JSON terbaca'); }catch(e){ refs.qrAreaName.value=code.data; alert('QR text terbaca'); } } else alert('QR tidak terdeteksi'); }; img.onerror = ()=> alert('Gagal baca file'); img.src = URL.createObjectURL(f); });

  async function startScanOne(allowGallery){
    try{ await startCameraScan(); return await new Promise((resolve)=>{ const interval=setInterval(()=>{ const txt=refs.scanResult.textContent||''; if(txt.includes('Hasil scan:')){ clearInterval(interval); const data=txt.replace('Hasil scan:','').trim(); resolve(data); } },300); setTimeout(()=>{ clearInterval(interval); stopCameraScan(); resolve(null); },30000); }); }catch(e){ return new Promise((resolve)=>{ refs.fileScanInput.click(); refs.fileScanInput.onchange = function(ev){ const f = ev.target.files && ev.target.files[0]; if(!f) return resolve(null); const img = new Image(); img.onload = ()=>{ canvasForScan.width=img.width; canvasForScan.height=img.height; ctxForScan.drawImage(img,0,0); const d = ctxForScan.getImageData(0,0,canvasForScan.width,canvasForScan.height); const code = jsQR(d.data,d.width,d.height); if(code) resolve(code.data); else resolve(null); }; img.onerror = ()=> resolve(null); img.src = URL.createObjectURL(f); }; }); }
  }

  // signature
  const sCanvas = refs.sigCanvas, sCtx = sCanvas.getContext('2d'); let drawing=false, last=null;
  function sp(e){ const r=sCanvas.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
  function sDown(e){ drawing=true; last=sp(e); document.body.style.overflow='hidden'; e.preventDefault(); }
  function sMove(e){ if(!drawing) return; const p=sp(e); sCtx.beginPath(); sCtx.moveTo(last.x,last.y); sCtx.lineTo(p.x,p.y); sCtx.lineCap='round'; sCtx.lineWidth=2.6; sCtx.strokeStyle='#111'; sCtx.stroke(); last=p; e.preventDefault(); }
  function sUp(e){ drawing=false; last=null; document.body.style.overflow=''; }
  sCanvas.addEventListener('mousedown', sDown); sCanvas.addEventListener('mousemove', sMove); sCanvas.addEventListener('mouseup', sUp);
  sCanvas.addEventListener('touchstart', sDown, {passive:false}); sCanvas.addEventListener('touchmove', sMove, {passive:false}); sCanvas.addEventListener('touchend', sUp);
  refs.btnClearSig.addEventListener('click', ()=>{ sCtx.clearRect(0,0,sCanvas.width,sCanvas.height); state.signature=null; refs.sigPreview.innerHTML=''; });
  refs.btnSaveSig.addEventListener('click', ()=>{ const data=sCanvas.toDataURL('image/png'); state.signature=data; refs.sigPreview.innerHTML = '<img src="'+data+'" style="width:160px;height:70px;object-fit:contain">'; alert('Tanda tangan tersimpan'); });

  refs.btnDeepClean.addEventListener('click', ()=> refs.modalBackdrop.style.display='flex');
  refs.btnDeepCancel.addEventListener('click', ()=> alert('Deep Clean dibatalkan'));
  refs.modalCancel.addEventListener('click', ()=> refs.modalBackdrop.style.display='none');
  refs.modalOk.addEventListener('click', ()=>{ doDeepClean(); refs.modalBackdrop.style.display='none'; alert('Deep Clean selesai'); });

  function doDeepClean(){
    state.areas.forEach(a=> a.photos.forEach(p=> revoke(p.url)));
    if (state.profilePhoto) revoke(state.profilePhoto.url);
    state.areas=[]; state.checkpoints=[]; state.gpsPath=[]; state.signature=null; state.profilePhoto=null;
    try{ window.__patrol_admin_password = null; }catch(e){}
    const ids=['areasContainer','qrCanvasManual','sigPreview','sigCanvas','qrAreaName','qrAreaDetail','manualLokasi','officerName','shift','date','newAreaName','newAreaDetail','adminPass','sigName'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='CANVAS'){ el.getContext('2d').clearRect(0,0,el.width,el.height); } else if(el.tagName==='DIV' || el.tagName==='SPAN'){ el.innerHTML=''; } else { try{ el.value=''; }catch(e){} } });
    try{ qrManual.set({ value:'' }); }catch(e){}
    renderAreas(); renderCheckpointList(); renderProfilePhoto(); state.isAdmin=false; updateModeUI();
  }

  // PDF Generator
  refs.btnGeneratePDF.addEventListener('click', async ()=>{
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm',format:'a4'});
      const margin = 12;
      const pageWidth = 210;
      const pageHeight = 297;
      const contentWidth = pageWidth - margin*2;
      const officer = refs.officerName.value || 'Petugas';
      const shiftVal = refs.shift.value || '';
      const tanggal = refs.date.value || new Date().toLocaleDateString('id-ID');
      const waktu = new Date().toLocaleTimeString();
      const lokasiHeader = refs.manualLokasi.value || (state.gpsPath.length ? `${state.gpsPath[state.gpsPath.length-1].lat.toFixed(6)}, ${state.gpsPath[state.gpsPath.length-1].lon.toFixed(6)}` : '-');

      // Cover Page
      doc.setFillColor(7, 32, 74);
      doc.rect(0, 0, pageWidth, 50, 'F');
      doc.setFontSize(24); 
      doc.setTextColor(255, 255, 255); 
      doc.text('LAPORAN PATROLI', pageWidth/2, 30, {align:'center'});
      
      const contentStartY = 60;
      const contentHeight = pageHeight - contentStartY - 20;
      const leftWidth = (pageWidth - margin*2) / 2;
      const rightWidth = leftWidth;
      
      // Left side: Data Petugas
      const leftX = margin;
      const leftY = contentStartY;
      
      doc.setFillColor(245, 247, 250);
      doc.rect(leftX, leftY, leftWidth, contentHeight, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(leftX, leftY, leftWidth, contentHeight);
      
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text('DATA PETUGAS', leftX + leftWidth/2, leftY + 15, {align:'center'});
      
      const dataRows = [
        {label: 'Nama', value: officer},
        {label: 'Tanggal', value: tanggal},
        {label: 'Shift', value: shiftVal},
        {label: 'Jam', value: waktu},
        {label: 'Lokasi', value: lokasiHeader}
      ];
      
      doc.setFontSize(11);
      let dataY = leftY + 35;
      const rowHeight = 20;
      
      dataRows.forEach(row => {
        doc.setFillColor(255, 255, 255);
        doc.rect(leftX + 8, dataY - 6, leftWidth - 16, 16, 'F');
        doc.setDrawColor(220, 220, 220);
        doc.rect(leftX + 8, dataY - 6, leftWidth - 16, 16);
        
        doc.setTextColor(80, 80, 80);
        doc.text(row.label + ':', leftX + 12, dataY + 2);
        doc.setTextColor(0, 0, 0);
        doc.text(String(row.value || '-'), leftX + 12, dataY + 8);
        
        dataY += rowHeight;
      });
      
      // Right side: Foto Profil
      const rightX = margin + leftWidth;
      const rightY = contentStartY;
      
      doc.setFillColor(245, 247, 250);
      doc.rect(rightX, rightY, rightWidth, contentHeight, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(rightX, rightY, rightWidth, contentHeight);
      
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text('FOTO PROFIL', rightX + rightWidth/2, rightY + 15, {align:'center'});
      
      if (state.profilePhoto) {
        try {
          const durl = await fetchAsDataUrl(state.profilePhoto.url);
          const props = doc.getImageProperties(durl);
          const photoMargin = 20;
          const maxWidth = rightWidth - photoMargin * 2;
          const maxHeight = contentHeight - 40;
          
          let imgWidth = maxWidth;
          let imgHeight = (props.height / props.width) * imgWidth;
          
          if (imgHeight > maxHeight) {
            imgHeight = maxHeight;
            imgWidth = (props.width / props.height) * imgHeight;
          }
          
          const imgX = rightX + (rightWidth - imgWidth) / 2;
          const imgY = rightY + 30;
          
          doc.addImage(durl, 'JPEG', imgX, imgY, imgWidth, imgHeight);
        } catch(e) {
          console.warn('Profile photo add failed', e);
          doc.setFontSize(12);
          doc.setTextColor(150, 150, 150);
          doc.text('Foto tidak dapat dimuat', rightX + rightWidth/2, rightY + 60, {align:'center'});
        }
      } else {
        doc.setFontSize(12);
        doc.setTextColor(150, 150, 150);
        doc.text('Tidak ada foto profil', rightX + rightWidth/2, rightY + 60, {align:'center'});
      }
      
      doc.addPage();

      // Area Pages
      for(const area of state.areas){
        if (doc.internal.getCurrentPageInfo().pageNumber > 1) {
          doc.addPage();
        }
        
        const rgb = colorForIdRgb(area.id);
        doc.setFillColor(rgb[0], rgb[1], rgb[2]);
        doc.rect(margin, 10, pageWidth - margin*2, 12, 'F');
        doc.setTextColor(255, 255, 255); 
        doc.setFontSize(14);
        doc.text(area.name + (area.detail ? ' ‚Äî ' + area.detail : ''), margin + 5, 18);
        doc.setTextColor(0, 0, 0);
        
        let cursorY = 25;
        
        if(area.description && area.description.trim()){
          const lines = doc.splitTextToSize(area.description, contentWidth - 10);
          const descHeight = lines.length * 5;
          
          if(cursorY + descHeight > pageHeight - margin - 50){
            doc.addPage(); 
            cursorY = margin;
          }
          
          doc.setFontSize(10); 
          doc.setFillColor(250, 250, 250);
          doc.rect(margin, cursorY, contentWidth, descHeight + 8, 'F');
          doc.setTextColor(0, 0, 0);
          doc.text(lines, margin + 5, cursorY + 6);
          cursorY += descHeight + 15;
        }
        
        for(const p of area.photos){
          try{
            const durl = await fetchAsDataUrl(p.url);
            const imgProps = doc.getImageProperties(durl);
            
            const photoWidth = contentWidth * 0.6;
            const descWidth = contentWidth * 0.4;
            const photoHeight = (imgProps.height / imgProps.width) * photoWidth;
            
            const descLines = p.desc && p.desc.trim() ? 
              doc.splitTextToSize(p.desc, descWidth - 15) : ['(Tidak ada deskripsi)'];
            const descHeight = Math.max(descLines.length * 4.5, photoHeight);
            
            const coordText = (p.lat && p.lon) ? 
              (`Koordinat: ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} ‚Äî ${p.ts ? new Date(p.ts).toLocaleString() : ''}`) : 
              'Koordinat: -';
            
            const blockNeeded = Math.max(photoHeight, descHeight) + 30;
            
            if(cursorY + blockNeeded > pageHeight - margin - 10){
              doc.addPage();
              cursorY = margin + 10;
            }
            
            const photoX = margin;
            const photoY = cursorY;
            doc.addImage(durl, 'JPEG', photoX, photoY, photoWidth, photoHeight);
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(coordText, photoX, photoY + photoHeight + 5);
            
            const descX = margin + photoWidth + 5;
            const descY = cursorY;
            
            doc.setFillColor(240, 245, 255);
            doc.rect(descX, descY, descWidth, descHeight, 'F');
            doc.setDrawColor(200, 210, 230);
            doc.rect(descX, descY, descWidth, descHeight);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            let textY = descY + 8;
            descLines.forEach(line => {
              if (textY < descY + descHeight - 5) {
                doc.text(line, descX + 5, textY);
                textY += 4.5;
              }
            });
            
            cursorY += Math.max(photoHeight, descHeight) + 20;
            
            if(cursorY < pageHeight - margin - 5){
              doc.setDrawColor(200, 200, 200);
              doc.setLineWidth(0.3);
              doc.line(margin, cursorY - 5, margin + contentWidth, cursorY - 5);
            }
            
          } catch(e) {
            console.warn('Photo processing failed', e);
          }
        }
        
        cursorY += 15;
      }

      // Signature page
      doc.addPage();
      doc.setFontSize(16); 
      doc.text('TANDA TANGAN PETUGAS', margin, 30);
      
      if(state.signature){
        try{ 
          const sigWidth = 80;
          const sigHeight = 40;
          const sigX = margin + (contentWidth - sigWidth) / 2;
          doc.addImage(state.signature, 'PNG', sigX, 45, sigWidth, sigHeight); 
        } catch(e) { 
          console.warn('Signature add failed', e); 
        }
      } else {
        doc.setFontSize(12); 
        doc.setTextColor(150, 150, 150);
        doc.text('(Tidak ada tanda tangan tersimpan)', margin, 55);
      }
      
      const lineY = 45 + 40 + 15;
      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.7); 
      doc.line(margin, lineY, margin + contentWidth, lineY);
      
      doc.setFontSize(12); 
      doc.setTextColor(0, 0, 0);
      const nameToPrint = refs.officerName.value || 'Petugas'; 
      doc.text(nameToPrint, margin + contentWidth/2, lineY + 8, {align:'center'});
      
      doc.setFontSize(9); 
      doc.setTextColor(100, 100, 100);
      doc.text('Tanda tangan sudah otomatis terverifikasi dan tervalidasi by system', margin, lineY + 18);

      const gpsSample = state.gpsPath.slice(-10).map(g => `${g.lat?.toFixed(6)||''},${g.lon?.toFixed(6)||''} @ ${new Date(g.timestamp||Date.now()).toLocaleString()}`);
      doc.setFontSize(8); 
      doc.setTextColor(0, 0, 0);
      doc.text('GPS path (latest 10):', margin, lineY + 30);
      doc.setFontSize(7); 
      doc.setTextColor(80, 80, 80);
      doc.text(doc.splitTextToSize(gpsSample.join('\n'), contentWidth), margin, lineY + 35);

      const ab = doc.output('arraybuffer');
      const blob = new Blob([ab], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'laporan_patroli_'+ (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_') + '.pdf';
      document.body.appendChild(a); 
      a.click(); 
      setTimeout(()=>{ 
        try{ 
          document.body.removeChild(a); 
          URL.revokeObjectURL(url);
        } catch(e){} 
      }, 1500);

    } catch(err) {
      console.error('Generate PDF failed', err);
      alert('Generate PDF gagal: '+(err.message||err));
    }
  });

  async function fetchAsDataUrl(url){
    const resp = await fetch(url); 
    const blob = await resp.blob();
    return await new Promise((res,rej)=>{ 
      const fr = new FileReader(); 
      fr.onload = ()=>res(fr.result); 
      fr.onerror = rej; 
      fr.readAsDataURL(blob); 
    });
  }

  // Cloudinary helper
  window.CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };
  window.uploadToCloudinary = function(file){
    return new Promise(function(resolve,reject){
      if(!file) return reject('No file');
      var url = 'https://api.cloudinary.com/v1_1/' + CLOUDINARY.cloudName + '/upload';
      var fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', CLOUDINARY.uploadPreset);
      var xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.onreadystatechange = function(){ if(xhr.readyState==4){ if(xhr.status==200){ try{ var res=JSON.parse(xhr.responseText); resolve(res.secure_url); }catch(e){ reject(e); } } else { reject(xhr.responseText || xhr.status); } } };
      xhr.send(fd);
    });
  };

  function getLocalUid(){
    var uid = localStorage.getItem('patrol_uid');
    if(uid) return uid;
    var u = 'anon_' + Math.random().toString(36).slice(2,9);
    localStorage.setItem('patrol_uid', u);
    return u;
  }
  window.getLocalUid = getLocalUid;

  // Initialize
  setupChatSystem();
  renderAreas(); 
  renderCheckpointList(); 
  renderProfilePhoto();
  updateModeUI();

  // Browser compatibility check
  (function(){
    const supports = { getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia), jsqr: !!window.jsQR, fetch: typeof fetch === 'function', download: (function(){ const a=document.createElement('a'); return typeof a.download !== 'undefined'; })() };
    if(!supports.getUserMedia){
      const banner = document.createElement('div');
      banner.style.cssText = 'position:fixed; left:10px; right:10px; top:60px; z-index:9999; padding:8px; border-radius:8px; text-align:center; background:#f59e0b; color:#000;';
      banner.textContent = 'Perhatian: Browser ini mungkin tidak mendukung kamera langsung. Gunakan "Scan dari File/Galeri" atau buka di Chrome Android untuk hasil terbaik.';
      document.body.appendChild(banner);
      setTimeout(()=>banner.remove(),10000);
    }
  })();

})();
</script>
</body>
</html>