<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli — Final Final</title>

<!-- CDN deps -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
:root{--bg:#f6f8fb;--card:#fff;--primary:#0b69ff;--muted:#6b7280;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:#111}
header{background:linear-gradient(90deg,#06204a,#0b1b3a);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px}
header h1{margin:0;font-size:17px}
.container{max-width:1200px;margin:12px auto;padding:10px;display:flex;gap:12px;flex-wrap:wrap}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 20px rgba(7,10,25,0.06)}
.sidebar{width:340px;min-width:260px}
label{display:block;margin:8px 0 6px;font-weight:700}
input[type=text], textarea, input[type=password]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fff}
textarea{min-height:80px;resize:vertical}
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,105,255,0.12)}
.btn.danger{background:var(--danger)}
.muted{color:var(--muted);font-size:13px}
.areas{margin-top:12px}
.area{border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #e9f0ff;background:linear-gradient(180deg,#fff,#fbfdff)}
.area-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.area-title{font-weight:800;font-size:16px;padding:6px 10px;border-radius:6px;color:#fff}
.photo-controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.photos{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.photo-item{width:140px;height:100px;border-radius:8px;overflow:hidden;position:relative;background:#f3f5f8;border:1px solid #e6eefb}
.photo-item img{width:100%;height:100%;object-fit:cover}
.photo-meta{font-size:11px;color:#374151;padding:6px;text-align:left}
.icon-btn{background:rgba(255,255,255,.98);border-radius:6px;padding:6px;border:0;cursor:pointer}
.signature-canvas{border:1px solid #e6e9ef;border-radius:8px;touch-action:none;background:#fff;display:block}
.sig-preview{width:160px;height:70px;border:1px solid #e6e9ef;border-radius:6px;overflow:hidden;background:#fff}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:10px;background:#eef2ff;color:var(--primary);cursor:pointer;font-weight:700}

/* ✅ INI YANG DITAMBAHIN BRO */
.hidden {
  display: none !important;
}

.qr-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;border:1px dashed #e6eefb;margin-bottom:8px;flex-wrap:wrap}
.small{font-size:13px;color:#555}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;padding:18px;border-radius:10px;max-width:420px;width:94%;box-shadow:0 14px 40px rgba(0,0,0,0.25)}
.video-preview{width:100%;height:220px;background:#000;border-radius:8px;object-fit:cover}
@media (max-width:900px){ .sidebar{width:100%} .container{padding:8px} .video-preview{height:180px} }
</style>
</head>
<body>
<header>
  <h1>Patroli — FINAL</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <div id="modeDisplay" style="background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-weight:700">Mode: User</div>
    <button id="btnToggleMode" class="btn ghost">Masuk Admin</button>
    <span id="gpsStatus" class="muted">GPS: belum</span>
    <button id="btnStartGPS" class="btn">Mulai GPS</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar">
    <div class="tabs">
      <div class="tab" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
      <div class="tab" id="tabDeep">DEEP CLEAN-UP</div>
    </div>

    <div id="areaTab">
      <label>Nama Petugas</label><input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label><input id="shift" type="text" placeholder="Contoh: Malam">
      <label>Tanggal</label><input id="date" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">—</span></div>
      <hr style="margin:10px 0">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" placeholder="Nama area (manual)...">
      <input id="newAreaDetail" type="text" placeholder="Detail lokasi (opsional)..." style="margin-top:8px">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn ghost">Scan QR (kamera)</button>
      </div>

      <div style="margin-top:12px" class="note">User hanya camera; Admin camera + gallery.</div>

      <div style="margin-top:12px" class="login-box">
        <div style="font-weight:700;margin-bottom:8px">Admin Login</div>
        <input id="adminPass" type="password" placeholder="Password admin...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLogin" class="btn">Login</button>
          <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
        </div>
      </div>
    </div>

    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Unlimited)</label>
      <div id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Manual (JSON)</label>
      <input id="qrAreaName" type="text" placeholder="Nama Area (contoh: AREA SELATAN)">
      <input id="qrAreaDetail" type="text" placeholder="Detail lokasi (contoh: PINTU LOBBY PERTAMA)" style="margin-top:8px">

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnGenerateQRManual" class="btn">Generate QR (JSON)</button>
        <button id="btnSaveCheckpoint" class="btn ghost">Simpan ke Daftar</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <canvas id="qrCanvasManual" style="border:1px solid #e6eefb;background:#fff;border-radius:6px"></canvas>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="btnDownloadQRManual" class="btn">Download QR</button>
          <button id="btnCopyQRDataManual" class="btn ghost">Copy QR DataURL</button>
          <button id="btnCopyQRContentManual" class="btn ghost">Copy QR Content</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Scanner (kamera langsung)</label>
        <video id="video" class="video-preview" autoplay muted playsinline></video>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnStartScan" class="btn ghost">Start Scan Camera</button>
          <button id="btnStopScan" class="btn ghost">Stop Scan</button>
          <input id="fileScanInput" type="file" accept="image/*" style="display:none">
          <button id="btnFileScan" class="btn ghost">Scan dari File/Galeri</button>
        </div>
        <div id="scanResult" class="muted" style="margin-top:8px">Hasil scan: —</div>
      </div>
    </div>

    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" placeholder="Contoh: SEI JKT11">
      <div class="note">Isi lokasi ini akan tampil di cover PDF (override GPS jika diisi).</div>
    </div>

    <div id="deepTab" class="hidden">
      <h3>DEEP CLEAN-UP</h3>
      <p>Hapus <strong>SEMUA DATA</strong> termasuk semua area, foto, logo, tanda tangan, password runtime. Aplikasi akan kembali seperti baru.</p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnDeepClean" class="btn danger">Deep Clean (OK)</button>
        <button id="btnDeepCancel" class="btn ghost">Batal</button>
      </div>
    </div>

    <hr style="margin:12px 0">
    <div class="note">Host via HTTPS (GitHub Pages) dan tes di Chrome Android untuk hasil terbaik.</div>
  </aside>

  <main class="card" style="flex:1 1 820px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="viewAreas">
      <div id="areasContainer" class="areas"></div>
    </section>

    <section id="viewSignature" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama pada tanda tangan...">
      <div style="margin-top:8px"><canvas id="sigCanvas" class="signature-canvas" width="700" height="140"></canvas></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div style="margin-left:12px"><div class="muted">Preview:</div><div id="sigPreview" class="sig-preview"></div></div>
      </div>
    </section>
  </main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>DEEP CLEAN-UP</h3>
    <p>Hapus <strong>SEMUA DATA</strong> termasuk: semua area patroli, semua foto, logo, tanda tangan, password akses. Aplikasi akan kembali seperti baru! Yakin ingin melanjutkan?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modalCancel" class="btn ghost">Batal</button>
      <button id="modalOk" class="btn danger">OK</button>
    </div>
  </div>
</div>

<script>
/* FINAL FINAL — improved pagination (photo+desc as single block), cover fix */
(function(){
  const $ = s => document.querySelector(s);
  const uid = (p='id')=> p+'-'+Math.random().toString(36).slice(2,9);
  const revoke = url => { try{ if(url) URL.revokeObjectURL(url);}catch(e){} };

  const state = {
    isAdmin:false,
    adminPassword: window.__patrol_admin_password ?? 'raja123',
    areas:[],
    checkpoints:[],
    gpsPath:[],
    signature:null
  };

  const refs = {
    modeDisplay: $('#modeDisplay'), btnToggleMode: $('#btnToggleMode'),
    btnStartGPS: $('#btnStartGPS'), gpsStatus: $('#gpsStatus'), coords: $('#coords'),
    btnAddArea: $('#btnAddArea'), newAreaName: $('#newAreaName'), newAreaDetail: $('#newAreaDetail'), areasContainer: $('#areasContainer'),
    tabAreas: $('#tabAreas'), tabCheckpoint: $('#tabCheckpoint'), tabLokasi: $('#tabLokasi'), tabDeep: $('#tabDeep'),
    areaTab: $('#areaTab'), checkpointTab: $('#checkpointTab'), lokasiTab: $('#lokasiTab'), deepTab: $('#deepTab'),
    btnScanAreaQR: $('#btnScanAreaQR'),
    btnGenerateQRManual: $('#btnGenerateQRManual'), qrCanvasManual: $('#qrCanvasManual'), btnDownloadQRManual: $('#btnDownloadQRManual'),
    btnCopyQRDataManual: $('#btnCopyQRDataManual'), btnCopyQRContentManual: $('#btnCopyQRContentManual'), btnSaveCheckpoint: $('#btnSaveCheckpoint'),
    qrAreaName: $('#qrAreaName'), qrAreaDetail: $('#qrAreaDetail'),
    btnLogin: $('#btnLogin'), btnLogout: $('#btnLogout'), adminPass: $('#adminPass'),
    btnGeneratePDF: $('#btnGeneratePDF'),
    tabViewAreas: $('#tabViewAreas'), tabSignature: $('#tabSignature'), viewAreas: $('#viewAreas'), viewSignature: $('#viewSignature'),
    sigCanvas: $('#sigCanvas'), btnClearSig: $('#btnClearSig'), btnSaveSig: $('#btnSaveSig'), sigPreview: $('#sigPreview'), sigName: $('#sigName'),
    btnDeepClean: $('#btnDeepClean'), btnDeepCancel: $('#btnDeepCancel'),
    modalBackdrop: $('#modalBackdrop'), modalOk: $('#modalOk'), modalCancel: $('#modalCancel'),
    manualLokasi: $('#manualLokasi'), officerName: $('#officerName'), shift: $('#shift'), date: $('#date'),
    video: $('#video'), btnStartScan: $('#btnStartScan'), btnStopScan: $('#btnStopScan'), scanResult: $('#scanResult'),
    fileScanInput: $('#fileScanInput'), btnFileScan: $('#btnFileScan'), qrList: $('#qrList')
  };

  function colorForId(id){ let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); return 'hsl('+ (Math.abs(h)%360) +',68%,36%)'; }
  function colorForIdRgb(id){ let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i); const hue = Math.abs(h)%360; return hslToRgb(hue/360,0.7,0.4); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; }else{ const hue2rgb=(p,q,t)=>{ if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}; const q = l<0.5? l*(1+s): l + s - l*s; const p = 2*l - q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} return [Math.round(r*255),Math.round(g*255),Math.round(b*255)]; }

  function updateModeUI(){ refs.modeDisplay.textContent = 'Mode: ' + (state.isAdmin ? 'Admin' : 'User'); refs.btnToggleMode.textContent = state.isAdmin ? 'Masuk User' : 'Masuk Admin'; refs.btnLogout.style.display = state.isAdmin ? 'inline-block' : 'none'; refs.btnLogin.style.display = state.isAdmin ? 'none' : 'inline-block'; renderAreas(); renderCheckpointList(); }
  refs.btnToggleMode.addEventListener('click', ()=>{ if(!state.isAdmin){ const p = prompt('Password Admin:'); if(p===null) return; if(p === state.adminPassword){ state.isAdmin = true; updateModeUI(); alert('Admin login'); } else alert('Password salah'); } else { state.isAdmin = false; updateModeUI(); alert('Mode User aktif'); } });
  refs.btnLogin.addEventListener('click', ()=>{ const p = refs.adminPass.value||''; if(p === state.adminPassword){ state.isAdmin = true; refs.adminPass.value=''; updateModeUI(); alert('Admin login'); } else alert('Password salah'); });
  refs.btnLogout.addEventListener('click', ()=>{ state.isAdmin = false; updateModeUI(); alert('Logout'); });

  let watchId = null;
  refs.btnStartGPS.addEventListener('click', ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } refs.btnStartGPS.style.display='none'; refs.gpsStatus.textContent='GPS: aktif'; watchId = navigator.geolocation.watchPosition(pos=>{ const lat = pos.coords.latitude, lon = pos.coords.longitude, ts = pos.timestamp; refs.coords.textContent = lat.toFixed(6) + ', ' + lon.toFixed(6) + ' @ ' + new Date(ts).toLocaleTimeString(); state.gpsPath.push({lat,lon,timestamp:ts}); }, err=>{ console.warn(err); refs.gpsStatus.textContent='GPS: error'; }, {enableHighAccuracy:true,maximumAge:2000,timeout:8000}); });

  refs.tabAreas.addEventListener('click', ()=>{ refs.areaTab.classList.remove('hidden'); refs.checkpointTab.classList.add('hidden'); refs.lokasiTab.classList.add('hidden'); refs.deepTab.classList.add('hidden'); });
  refs.tabCheckpoint.addEventListener('click', ()=>{ refs.areaTab.classList.add('hidden'); refs.checkpointTab.classList.remove('hidden'); refs.lokasiTab.classList.add('hidden'); refs.deepTab.classList.add('hidden'); });
  refs.tabLokasi.addEventListener('click', ()=>{ refs.areaTab.classList.add('hidden'); refs.checkpointTab.classList.add('hidden'); refs.lokasiTab.classList.remove('hidden'); refs.deepTab.classList.add('hidden'); });
  refs.tabDeep.addEventListener('click', ()=>{ refs.areaTab.classList.add('hidden'); refs.checkpointTab.classList.add('hidden'); refs.lokasiTab.classList.add('hidden'); refs.deepTab.classList.remove('hidden'); });
  refs.tabViewAreas.addEventListener('click', ()=>{ refs.viewAreas.classList.remove('hidden'); refs.viewSignature.classList.add('hidden'); });
  refs.tabSignature.addEventListener('click', ()=>{ refs.viewAreas.classList.add('hidden'); refs.viewSignature.classList.remove('hidden'); });

  refs.btnAddArea.addEventListener('click', ()=>{ addArea(refs.newAreaName.value.trim()||undefined, refs.newAreaDetail.value.trim()||undefined); refs.newAreaName.value=''; refs.newAreaDetail.value=''; });
  function addArea(name, detail){
    const id = uid('area'); state.areas.push({id,name: name || ('Area '+(state.areas.length+1)), detail: detail||'', description:'', photos:[]}); renderAreas();
  }

  function renderAreas(){
    refs.areasContainer.innerHTML = '';
    state.areas.forEach(area=>{
      const wrapper = document.createElement('div'); wrapper.className='area';
      const h = document.createElement('div'); h.className='area-header';
      const title = document.createElement('div'); title.className='area-title'; title.textContent = area.name + (area.detail ? ' — ' + area.detail : ''); title.style.background = colorForId(area.id);
      h.appendChild(title);
      const actions = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='<i class="fa fa-pen"></i>'; editBtn.title='Edit nama area';
      editBtn.onclick = ()=>{ const nv = prompt('Edit nama area:', area.name); if(nv!==null){ area.name = nv; renderAreas(); } };
      const qrBtn = document.createElement('button'); qrBtn.className='icon-btn'; qrBtn.innerHTML='<i class="fa fa-qrcode"></i>'; qrBtn.title='Scan QR to fill area';
      qrBtn.onclick = async ()=>{ try{ const content = await startScanOne(false); if(!content) return; try{ const p = JSON.parse(content); if(p && p.area){ area.name = p.area; area.detail = p.detail||area.detail; renderAreas(); alert('Area terisi dari QR'); return; } }catch(e){ area.name = content; renderAreas(); alert('Area terisi: '+content); } } catch(e){ alert('Scan QR gagal: '+(e.message||e)); } };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML='<i class="fa fa-trash" style="color:#b91c1c"></i>'; delBtn.title='Hapus area';
      delBtn.onclick = ()=>{ if(confirm('Hapus area & semua fotonya?')){ area.photos.forEach(p=>revoke(p.url)); state.areas = state.areas.filter(x=>x.id!==area.id); renderAreas(); } };
      actions.appendChild(editBtn); actions.appendChild(qrBtn); actions.appendChild(delBtn);
      h.appendChild(actions); wrapper.appendChild(h);

      const pc = document.createElement('div'); pc.className='photo-controls';
      if(state.isAdmin){
        const galBtn = document.createElement('button'); galBtn.className='btn ghost'; galBtn.textContent='Pilih dari Galeri (multiple)';
        galBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:true,multiple:true}); await handleFiles(area.id,r.files,r.pos); };
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(galBtn); pc.appendChild(camBtn);
      } else {
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFiles(area.id,r.files,r.pos); };
        pc.appendChild(camBtn);
      }
      wrapper.appendChild(pc);

      const photosWrap = document.createElement('div'); photosWrap.className='photos';
      area.photos.forEach(p=>{
        const col = document.createElement('div'); col.style.width='170px';
        const photoItem = document.createElement('div'); photoItem.className='photo-item';
        const img = document.createElement('img'); img.src = p.url; photoItem.appendChild(img);
        const actionWrap = document.createElement('div'); actionWrap.style.position='absolute'; actionWrap.style.left='6px'; actionWrap.style.bottom='6px'; actionWrap.style.display='flex'; actionWrap.style.gap='6px';
        const del = document.createElement('button'); del.className='icon-btn'; del.innerHTML='<i class="fa fa-trash" style="color:#b91c1c"></i>';
        del.onclick = ()=>{ if(confirm('Hapus foto?')){ area.photos = area.photos.filter(pp=>pp.id!==p.id); revoke(p.url); renderAreas(); } };
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.innerHTML='<i class="fa fa-pen" style="color:#0b1228"></i>';
        edit.onclick = ()=>{ const v = prompt('Deskripsi (tanpa batas):', p.desc||''); if(v!==null){ p.desc = v; renderAreas(); } };
        actionWrap.appendChild(del); actionWrap.appendChild(edit); photoItem.appendChild(actionWrap);
        const meta = document.createElement('div'); meta.className='photo-meta';
        meta.innerHTML = `<div style="font-weight:700">${p.desc || '(klik pensil untuk deskripsi)'}</div>
          <div style="font-size:11px;color:#555">${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>${p.ts? new Date(p.ts).toLocaleString(): ''}</div>`;
        col.appendChild(photoItem); col.appendChild(meta); photosWrap.appendChild(col);
      });
      wrapper.appendChild(photosWrap);

      const ta = document.createElement('textarea'); ta.placeholder='Deskripsi area...'; ta.value = area.description || ''; ta.oninput = ()=> area.description = ta.value;
      const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Simpan Deskripsi Area'; saveBtn.style.marginTop='8px'; saveBtn.onclick = ()=> alert('Deskripsi area disimpan');
      wrapper.appendChild(ta); wrapper.appendChild(saveBtn);

      refs.areasContainer.appendChild(wrapper);
    });
  }

  function createFileInput(opts){
    return new Promise(resolve=>{
      function getPos(cb){ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>cb({lat:p.coords.latitude,lon:p.coords.longitude,ts:p.timestamp}), ()=>cb(null), {enableHighAccuracy:true,timeout:4000}); } else cb(null); }
      getPos(function(pos){
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; if(opts.multiple) inp.multiple=true; if(!opts.allowGallery) inp.setAttribute('capture','environment');
        inp.style.display='none'; document.body.appendChild(inp);
        inp.addEventListener('change', e=>{ const files = Array.from(e.target.files || []); try{ document.body.removeChild(inp);}catch(e){}; resolve({files,pos}); });
        inp.click();
        setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; resolve({files:[],pos}); },30000);
      });
    });
  }

  async function handleFiles(areaId, files, pos){
    const area = state.areas.find(a=>a.id===areaId); if(!area) return;
    for(const f of files){
      const id = uid('photo'); const url = URL.createObjectURL(f);
      let lat=null, lon=null, ts=null;
      if(pos){ lat = pos.lat; lon = pos.lon; ts = pos.ts; }
      else if(state.gpsPath.length){ const g = state.gpsPath[state.gpsPath.length-1]; lat=g.lat; lon=g.lon; ts=g.timestamp; }
      area.photos.push({id,file:f,url,desc:'',lat,lon,ts});
    }
    renderAreas();
  }

  const qrManual = new QRious({ element: refs.qrCanvasManual, size: 220, value: '' });
  function buildQRJson(area, detail){ const a=(area||'').trim(); const d=(detail||'').trim(); return JSON.stringify({area:a,detail:d}); }
  refs.btnGenerateQRManual.addEventListener('click', ()=>{ const content = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); if(!refs.qrAreaName.value.trim() && !refs.qrAreaDetail.value.trim()){ alert('Isi area atau detail'); return; } qrManual.set({ value: content, size: 300 }); try{ navigator.clipboard.writeText(content); }catch(e){} alert('QR JSON dibuat & disalin (opsional)'); });
  refs.btnDownloadQRManual.addEventListener('click', ()=>{ try{ const dataUrl = qrManual.toDataURL('image/png'); const a = document.createElement('a'); a.href = dataUrl; a.download = 'checkpoint_json_'+Date.now()+'.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); }catch(e){ alert('Download QR gagal'); } });
  refs.btnCopyQRDataManual.addEventListener('click', ()=>{ try{ const d = qrManual.toDataURL('image/png'); navigator.clipboard.writeText(d).then(()=>alert('DataURL QR disalin')); }catch(e){ alert('Copy fail'); } });
  refs.btnCopyQRContentManual.addEventListener('click', ()=>{ const c = buildQRJson(refs.qrAreaName.value, refs.qrAreaDetail.value); navigator.clipboard.writeText(c).then(()=>alert('Content disalin')); });

  refs.btnSaveCheckpoint.addEventListener('click', ()=>{ const area=(refs.qrAreaName.value||'').trim(); const detail=(refs.qrAreaDetail.value||'').trim(); if(!area && !detail) return alert('Isi area atau detail'); const content=buildQRJson(area,detail); const id=uid('cp'); state.checkpoints.push({id,area,detail,content}); refs.qrAreaName.value=''; refs.qrAreaDetail.value=''; qrManual.set({ value:'' }); renderCheckpointList(); alert('Checkpoint disimpan'); });

  function renderCheckpointList(){ refs.qrList.innerHTML=''; state.checkpoints.forEach(cp=>{ const row = document.createElement('div'); row.className='qr-row'; row.innerHTML = `<div style="flex:1"><strong>${cp.area||'(tanpa nama)'}</strong><div class="small">${cp.content}</div></div>`; const gen = document.createElement('button'); gen.className='btn'; gen.textContent='Preview QR'; gen.onclick=()=>{ qrManual.set({ value: cp.content, size:300 }); refs.qrAreaName.value = cp.area; refs.qrAreaDetail.value = cp.detail; }; const copy = document.createElement('button'); copy.className='btn ghost'; copy.textContent='Copy'; copy.onclick = ()=> navigator.clipboard.writeText(cp.content).then(()=>alert('Copied')); const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='Download'; dl.onclick = ()=>{ try{ const tmp = new QRious({ value: cp.content, size:300 }); const dataUrl = tmp.toDataURL('image/png'); const a = document.createElement('a'); a.href = dataUrl; a.download = 'checkpoint_json_'+cp.id+'.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ document.body.removeChild(a);}catch(e){} },800); }catch(e){ alert('Download fail'); } }; const del = document.createElement('button'); del.className='btn danger'; del.textContent='Hapus'; del.onclick=()=>{ if(confirm('Hapus checkpoint?')){ state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id); renderCheckpointList(); } }; row.appendChild(gen); row.appendChild(copy); row.appendChild(dl); row.appendChild(del); refs.qrList.appendChild(row); }); }

  // Camera scan with jsQR
  let scanning=false, streamRef=null;
  const video = refs.video;
  const canvasForScan = document.createElement('canvas'), ctxForScan = canvasForScan.getContext('2d');

  async function startCameraScan(){
    if(scanning) return;
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      streamRef = stream;
      video.srcObject = stream;
      await video.play();
      scanning=true; tickScan();
    }catch(err){ console.error(err); alert('Tidak bisa akses kamera: '+(err.message||err)); scanning=false; }
  }
  async function stopCameraScan(){ scanning=false; if(streamRef){ streamRef.getTracks().forEach(t=>t.stop()); streamRef=null; } try{ video.pause(); video.srcObject=null; }catch(e){} }
  function tickScan(){
    if(!scanning) return;
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      const vw=video.videoWidth, vh=video.videoHeight;
      canvasForScan.width=vw; canvasForScan.height=vh;
      ctxForScan.drawImage(video,0,0,vw,vh);
      const imgData = ctxForScan.getImageData(0,0,vw,vh);
      const code = jsQR(imgData.data,imgData.width,imgData.height);
      if(code){ refs.scanResult.textContent = 'Hasil scan: ' + code.data; stopCameraScan(); try{ const p = JSON.parse(code.data); refs.qrAreaName.value = p.area || ''; refs.qrAreaDetail.value = p.detail || ''; alert('QR JSON terbaca'); }catch(e){ refs.qrAreaName.value = code.data; alert('QR text terbaca'); } return; } else { refs.scanResult.textContent = 'Hasil scan: tidak terdeteksi'; }
    }
    requestAnimationFrame(tickScan);
  }
  refs.btnStartScan.addEventListener('click', ()=> startCameraScan());
  refs.btnStopScan.addEventListener('click', ()=> stopCameraScan());
  refs.btnFileScan.addEventListener('click', ()=> refs.fileScanInput.click());
  refs.fileScanInput.addEventListener('change', async (e)=>{ const f = e.target.files && e.target.files[0]; if(!f) return; const img = new Image(); img.onload = ()=>{ canvasForScan.width=img.width; canvasForScan.height=img.height; ctxForScan.drawImage(img,0,0); const d = ctxForScan.getImageData(0,0,canvasForScan.width,canvasForScan.height); const code = jsQR(d.data,d.width,d.height); if(code){ refs.scanResult.textContent = 'Hasil scan: '+code.data; try{ const p = JSON.parse(code.data); refs.qrAreaName.value=p.area||''; refs.qrAreaDetail.value=p.detail||''; alert('QR JSON terbaca'); }catch(e){ refs.qrAreaName.value=code.data; alert('QR text terbaca'); } } else alert('QR tidak terdeteksi'); }; img.onerror = ()=> alert('Gagal baca file'); img.src = URL.createObjectURL(f); });

  async function startScanOne(allowGallery){
    try{ await startCameraScan(); return await new Promise((resolve)=>{ const interval=setInterval(()=>{ const txt=refs.scanResult.textContent||''; if(txt.includes('Hasil scan:')){ clearInterval(interval); const data=txt.replace('Hasil scan:','').trim(); resolve(data); } },300); setTimeout(()=>{ clearInterval(interval); stopCameraScan(); resolve(null); },30000); }); }catch(e){ return new Promise((resolve)=>{ refs.fileScanInput.click(); refs.fileScanInput.onchange = function(ev){ const f = ev.target.files && ev.target.files[0]; if(!f) return resolve(null); const img = new Image(); img.onload = ()=>{ canvasForScan.width=img.width; canvasForScan.height=img.height; ctxForScan.drawImage(img,0,0); const d = ctxForScan.getImageData(0,0,canvasForScan.width,canvasForScan.height); const code = jsQR(d.data,d.width,d.height); if(code) resolve(code.data); else resolve(null); }; img.onerror = ()=> resolve(null); img.src = URL.createObjectURL(f); }; }); }
  }

  // signature
  const sCanvas = refs.sigCanvas, sCtx = sCanvas.getContext('2d'); let drawing=false, last=null;
  function sp(e){ const r=sCanvas.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
  function sDown(e){ drawing=true; last=sp(e); document.body.style.overflow='hidden'; e.preventDefault(); }
  function sMove(e){ if(!drawing) return; const p=sp(e); sCtx.beginPath(); sCtx.moveTo(last.x,last.y); sCtx.lineTo(p.x,p.y); sCtx.lineCap='round'; sCtx.lineWidth=2.6; sCtx.strokeStyle='#111'; sCtx.stroke(); last=p; e.preventDefault(); }
  function sUp(e){ drawing=false; last=null; document.body.style.overflow=''; }
  sCanvas.addEventListener('mousedown', sDown); sCanvas.addEventListener('mousemove', sMove); sCanvas.addEventListener('mouseup', sUp);
  sCanvas.addEventListener('touchstart', sDown, {passive:false}); sCanvas.addEventListener('touchmove', sMove, {passive:false}); sCanvas.addEventListener('touchend', sUp);
  refs.btnClearSig.addEventListener('click', ()=>{ sCtx.clearRect(0,0,sCanvas.width,sCanvas.height); state.signature=null; refs.sigPreview.innerHTML=''; });
  refs.btnSaveSig.addEventListener('click', ()=>{ const data=sCanvas.toDataURL('image/png'); state.signature=data; refs.sigPreview.innerHTML = '<img src="'+data+'" style="width:160px;height:70px;object-fit:contain">'; alert('Tanda tangan tersimpan'); });

  refs.btnDeepClean.addEventListener('click', ()=> refs.modalBackdrop.style.display='flex');
  refs.btnDeepCancel.addEventListener('click', ()=> alert('Deep Clean dibatalkan'));
  refs.modalCancel.addEventListener('click', ()=> refs.modalBackdrop.style.display='none');
  refs.modalOk.addEventListener('click', ()=>{ doDeepClean(); refs.modalBackdrop.style.display='none'; alert('Deep Clean selesai'); });

  function doDeepClean(){
    state.areas.forEach(a=> a.photos.forEach(p=> revoke(p.url)));
    state.areas=[]; state.checkpoints=[]; state.gpsPath=[]; state.signature=null;
    try{ window.__patrol_admin_password = null; }catch(e){}
    const ids=['areasContainer','qrCanvasManual','sigPreview','sigCanvas','qrAreaName','qrAreaDetail','manualLokasi','officerName','shift','date','newAreaName','newAreaDetail','adminPass','sigName'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='CANVAS'){ el.getContext('2d').clearRect(0,0,el.width,el.height); } else if(el.tagName==='DIV' || el.tagName==='SPAN'){ el.innerHTML=''; } else { try{ el.value=''; }catch(e){} } });
    try{ qrManual.set({ value:'' }); }catch(e){}
    renderAreas(); renderCheckpointList(); state.isAdmin=false; updateModeUI();
  }

  // IMPROVED PDF generator: better text wrapping and layout
  refs.btnGeneratePDF.addEventListener('click', async ()=>{
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm',format:'a4'});
      const margin = 12;
      const pageWidth = 210;
      const pageHeight = 297;
      const contentWidth = pageWidth - margin*2;
      const officer = refs.officerName.value || 'Petugas';
      const shiftVal = refs.shift.value || '';
      const tanggal = refs.date.value || new Date().toLocaleDateString('id-ID');
      const waktu = new Date().toLocaleTimeString();
      const lokasiHeader = refs.manualLokasi.value || (state.gpsPath.length ? `${state.gpsPath[state.gpsPath.length-1].lat.toFixed(6)}, ${state.gpsPath[state.gpsPath.length-1].lon.toFixed(6)}` : '-');

      // COVER PAGE: left table + right big photo (if provided)
      doc.setFillColor(200,222,249);
      doc.rect(0,0,pageWidth,40,'F');
      doc.setFontSize(24); doc.setTextColor(10,10,10); doc.text('PETUGAS PATROLI', pageWidth/2, 24, {align:'center'});
      const leftX = margin, leftY = 50, labelW = 40, cellW = 90, rowH = 12;
      const rows = ['NAMA','Hari/Tanggal','Shift','Jam','Lokasi'];
      const values = [officer, tanggal, shiftVal, waktu, refs.manualLokasi.value || lokasiHeader];
      doc.setFontSize(10);
      for(let i=0;i<rows.length;i++){
        const y = leftY + i*rowH;
        doc.setFillColor(245,245,245);
        doc.rect(leftX, y, labelW, rowH, 'F');
        doc.rect(leftX+labelW, y, cellW, rowH);
        doc.setTextColor(0,0,0);
        doc.text(rows[i], leftX+3, y+8);
        doc.text(String(values[i]||''), leftX+labelW+4, y+8);
      }
      // photo right
      const photoRightX = leftX + labelW + cellW + 8;
      const photoRightW = pageWidth - margin - photoRightX;
      if(state.areas.length){
        // try to find a profile photo from first area's first photo if exists
        const p0 = state.areas[0].photos[0];
        if(p0){
          try{
            const durl = await fetchAsDataUrl(p0.url);
            const props = doc.getImageProperties(durl);
            const w = photoRightW;
            const h = (props.height/props.width) * w;
            doc.addImage(durl, 'JPEG', photoRightX, leftY, w, Math.min(h, 80));
          }catch(e){ console.warn('cover photo add fail', e); }
        }
      }
      // cover done
      doc.addPage();

      // Iterate areas and place photos
      for(const area of state.areas){
        // area header band
        const rgb = colorForIdRgb(area.id);
        doc.setFillColor(rgb[0],rgb[1],rgb[2]);
        doc.rect(margin, 10, pageWidth - margin*2, 10, 'F');
        doc.setTextColor(255,255,255); doc.setFontSize(14);
        doc.text(area.name + (area.detail ? ' — ' + area.detail : ''), margin + 3, 17);
        doc.setTextColor(0,0,0);
        let cursorY = 22;

        // area description (if any) displayed before photos (optional)
        if(area.description && area.description.trim()){
          const lines = doc.splitTextToSize(area.description, contentWidth);
          const descHeight = lines.length * 5;
          if(cursorY + descHeight > pageHeight - margin - 60){
            doc.addPage(); cursorY = margin;
          }
          doc.setFontSize(10); doc.text(lines, margin, cursorY + 6);
          cursorY += descHeight + 6;
        }

        // photos loop - IMPROVED: better text wrapping and layout
        for(const p of area.photos){
          try{
            const durl = await fetchAsDataUrl(p.url);
            const imgProps = doc.getImageProperties(durl);
            
            // compute rendered size: fit to contentWidth with max width
            const maxImgW = contentWidth;
            const imgW = maxImgW;
            const imgH = (imgProps.height / imgProps.width) * imgW;
            
            // ✅ IMPROVED: Better text wrapping for long descriptions
            const descLines = p.desc && p.desc.trim() ? 
              doc.splitTextToSize(p.desc, contentWidth - 20) : []; // Kurangi margin untuk text
            const descH = descLines.length * 4.5; // Lebih rapat
            
            const coordText = (p.lat && p.lon) ? 
              (`Koordinat: ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} — ${p.ts? new Date(p.ts).toLocaleString() : ''}`) : 
              'Koordinat: -';
            const coordH = 5;
            const gapAfter = 6;
            
            // Calculate total block height needed
            const blockNeeded = imgH + descH + coordH + gapAfter + 8;

            // ✅ IMPROVED: If doesn't fit in remaining page space, move entire block to new page
            if(cursorY + blockNeeded > pageHeight - margin - 10){
              doc.addPage();
              cursorY = margin + 6;
              
              // Re-add area header if new page
              doc.setFillColor(rgb[0],rgb[1],rgb[2]);
              doc.rect(margin, 10, pageWidth - margin*2, 10, 'F');
              doc.setTextColor(255,255,255); doc.setFontSize(14);
              doc.text(area.name + (area.detail ? ' — ' + area.detail : ''), margin + 3, 17);
              doc.setTextColor(0,0,0);
              cursorY = 22;
            }

            // ✅ Place image - CENTERED
            const imgX = margin + (contentWidth - imgW) / 2; // Center the image
            doc.addImage(durl, 'JPEG', imgX, cursorY, imgW, imgH);
            cursorY += imgH + 6;

            // ✅ IMPROVED: Place description (if any) - LEFT ALIGNED, NO CHARACTER LIMIT
            if(descLines.length > 0){
              doc.setFontSize(10);
              doc.setTextColor(0,0,0);
              
              // Background for description (optional)
              doc.setFillColor(250,250,250);
              doc.rect(margin, cursorY - 2, contentWidth, descH + 4, 'F');
              
              // Text dengan rata kiri
              for(let i = 0; i < descLines.length; i++){
                if(cursorY > pageHeight - margin - 10){
                  doc.addPage();
                  cursorY = margin + 6;
                }
                doc.text(descLines[i], margin + 4, cursorY + 4);
                cursorY += 4.5;
              }
              cursorY += 2;
            }

            // ✅ Place coords - LEFT ALIGNED
            doc.setFontSize(8);
            doc.setTextColor(100,100,100);
            if(cursorY > pageHeight - margin - 10){
              doc.addPage();
              cursorY = margin + 6;
            }
            doc.text(coordText, margin, cursorY + 2);
            cursorY += coordH + gapAfter;

            // ✅ Add separator line between photos
            if(cursorY < pageHeight - margin - 5){
              doc.setDrawColor(200,200,200);
              doc.setLineWidth(0.3);
              doc.line(margin, cursorY, margin + contentWidth, cursorY);
              cursorY += 3;
            }

          }catch(e){
            console.warn('photo add fail', e);
          }
        }
        
        // ✅ Add space between areas
        cursorY += 10;
        if(cursorY > pageHeight - margin - 20){
          doc.addPage();
          cursorY = margin;
        }
      }

      // signature page
      doc.addPage();
      doc.setFontSize(12); doc.text('Tanda Tangan Petugas', margin, 26);
      if(state.signature){
        try{ 
          // ✅ Center the signature
          const sigWidth = 80;
          const sigHeight = 40;
          const sigX = margin + (contentWidth - sigWidth) / 2;
          doc.addImage(state.signature, 'PNG', sigX, 34, sigWidth, sigHeight); 
        }catch(e){ console.warn('sig add', e); }
      } else {
        doc.setFontSize(10); doc.text('(Tidak ada tanda tangan tersimpan)', margin, 44);
      }
      const lineX = margin, lineW = contentWidth, lineY = 34 + 40 + 12;
      doc.setLineWidth(0.7); doc.line(lineX, lineY, lineX + lineW, lineY);
      doc.setFontSize(11); const nameToPrint = refs.officerName.value || 'Petugas'; 
      doc.text(nameToPrint, lineX + lineW/2, lineY + 8, {align:'center'});
      doc.setFontSize(9); doc.text('Tanda tangan sudah otomatis terverifikasi dan tervalidasi by system', margin, lineY + 18);

      // gps summary
      const gpsSample = state.gpsPath.slice(-10).map(g => `${g.lat?.toFixed(6)||''},${g.lon?.toFixed(6)||''} @ ${new Date(g.timestamp||Date.now()).toLocaleString()}`);
      doc.setFontSize(8); doc.text('GPS path (latest 10):', margin, lineY + 30);
      doc.setFontSize(7); doc.text(doc.splitTextToSize(gpsSample.join('\n'), contentWidth), margin, lineY + 34);

      const ab = doc.output('arraybuffer');
      const blob = new Blob([ab], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'laporan_patroli_'+ (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_') + '.pdf';
      document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ document.body.removeChild(a); URL.revokeObjectURL(url);}catch(e){} },1500);

    }catch(err){
      console.error('Generate PDF failed', err);
      alert('Generate PDF gagal: '+(err.message||err));
    }
  });

  async function fetchAsDataUrl(url){
    const resp = await fetch(url); const blob = await resp.blob();
    return await new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=>res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob); });
  }

  // expose
  window.__patrol_state = state;
  window.__patrol_api = { renderAreas, renderCheckpointList, doDeepClean };

  // render initial
  renderAreas(); renderCheckpointList(); updateModeUI();

  // compatibility banner - helpful message if browser lacks getUserMedia
  (function(){
    const supports = { getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia), jsqr: !!window.jsQR, fetch: typeof fetch === 'function', download: (function(){ const a=document.createElement('a'); return typeof a.download !== 'undefined'; })() };
    const banner = document.createElement('div');
    banner.style.position='fixed'; banner.style.left='10px'; banner.style.right='10px'; banner.style.top='60px'; banner.style.zIndex=9999; banner.style.padding='8px'; banner.style.borderRadius='8px'; banner.style.textAlign='center';
    if(!supports.getUserMedia){ banner.style.background='#f59e0b'; banner.style.color='#000'; banner.textContent='Perhatian: Browser ini mungkin tidak mendukung kamera langsung. Gunakan "Scan dari File/Galeri" atau buka di Chrome Android untuk hasil terbaik.'; document.body.appendChild(banner); setTimeout(()=>banner.remove(),10000); }
  })();

})();
</script>

<!-- BEGIN INTEGRATION PATCH: FULL FEATURES (NON-INTRUSIVE) -->
<!-- This script uses your existing HTML structure. It does not replace or rewrite your HTML. -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script>
(function(){
  // CONFIG from project (already agreed)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBlW0bCNzY9X-6u8jF5Bqt0TT9egcYC-VU",
    authDomain: "patroilgptracking.firebaseapp.com",
    databaseURL: "https://patroilgptracking-default-rtdb.firebaseio.com",
    projectId: "patroilgptracking",
    storageBucket: "patroilgptracking.firebasestorage.app",
    messagingSenderId: "653208547594",
    appId: "1:653208547594:web:7c187fc4a4fba5b815caf3"
  };
  try{ firebase.initializeApp(FIREBASE_CONFIG); }catch(e){ console.warn('firebase init:', e); }
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Use existing officer identifier if present, otherwise use auth.uid once signed in.
  // We'll try to sign in anonymously automatically.
  auth.signInAnonymously().catch(()=>{ /* ignore */ });

  // helper to get element by id safely
  function $id(id){ return document.getElementById(id); }

  // Expose helper to update presence, GPS, photos, signature in a way that uses your existing DOM.
  window.PATROL = window.PATROL || {};
  PATROL.uid = null;
  PATROL.ready = false;

  auth.onAuthStateChanged(user=>{
    if(!user) return;
    PATROL.uid = user.uid;
    PATROL.ready = true;
    // if page has input officerName, update officers record
    const nameEl = $id('officerName');
    const phoneEl = $id('officerPhone');
    const shiftEl = $id('shift');
    const name = nameEl ? nameEl.value || 'Petugas' : (localStorage.getItem('patrol_name') || 'Petugas');
    const phone = phoneEl ? phoneEl.value || null : (localStorage.getItem('patrol_phone') || null);
    const shift = shiftEl ? shiftEl.value || '' : (localStorage.getItem('patrol_shift') || '');
    // save locally too
    try{ if(nameEl) localStorage.setItem('patrol_name', name); if(phoneEl) localStorage.setItem('patrol_phone', phone); if(shiftEl) localStorage.setItem('patrol_shift', shift); }catch(e){}
    // update officers profile node (non-destructive)
    db.ref('/officers/'+PATROL.uid).update({ name: name, phone: phone, role: 'patrol', shift: shift }).catch(()=>{});
    // initial presence
    PATROL.sendPresence();
    // update UI element if it exists
    const uidSpan = $id('uidSpan'); if(uidSpan) uidSpan.textContent = PATROL.uid;
  });

  // send presence function
  PATROL.sendPresence = function(extra){
    if(!PATROL.uid) return;
    const nameEl = $id('officerName');
    const payload = Object.assign({
      officerId: PATROL.uid,
      officerName: nameEl ? nameEl.value || localStorage.getItem('patrol_name') || 'Petugas' : localStorage.getItem('patrol_name') || 'Petugas',
      online: true,
      lastSeen: Date.now(),
      shift: ($id('shift') && $id('shift').value) || localStorage.getItem('patrol_shift') || ''
    }, extra || {});
    db.ref('/live/'+PATROL.uid+'/presence').set(payload).catch(()=>{});
  };

  // heartbeat interval
  setInterval(()=> PATROL.sendPresence(), 20000);

  // GPS functions: robust getCurrentPosition with retries and fallback to watchPosition
  PATROL.gps = {
    watchId: null,
    last: null,
    tryCount: 0,
    maxTry: 4
  };

  function gpsSuccess(pos){
    const lat = pos.coords.latitude, lon = pos.coords.longitude, ts = pos.timestamp || Date.now();
    PATROL.gps.last = { lat, lon, ts };
    // update DOM if coords element exists
    const coordsEl = $id('coords');
    if(coordsEl) coordsEl.textContent = lat.toFixed(6)+', '+lon.toFixed(6);
    if(!PATROL.uid) return;
    db.ref('/live/'+PATROL.uid+'/lastGps').set(PATROL.gps.last).catch(()=>{});
    // also append to history
    db.ref('/history/'+PATROL.uid+'/'+Date.now()).set({ type:'gps', data: PATROL.gps.last, ts: Date.now() }).catch(()=>{});
    // update presence with gps
    PATROL.sendPresence({ lastGps: PATROL.gps.last });
  }
  function gpsError(err){
    console.warn('GPS error', err);
    PATROL.gps.tryCount++;
    if(PATROL.gps.tryCount <= PATROL.gps.maxTry){
      setTimeout(()=> tryGetPos(), 3000);
    } else {
      // fallback to watchPosition (more persistent)
      if(navigator.geolocation && PATROL.gps.watchId === null){
        PATROL.gps.watchId = navigator.geolocation.watchPosition(gpsSuccess, function(e){ console.warn('watchPosition err', e); }, { enableHighAccuracy:true, maximumAge:5000, timeout:20000 });
      }
    }
  }
  function tryGetPos(){
    if(!navigator.geolocation) return;
    try{
      navigator.geolocation.getCurrentPosition(gpsSuccess, gpsError, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 + (PATROL.gps.tryCount*4000) });
    }catch(e){ gpsError(e); }
  }

  // Wire to existing start/stop buttons (non-intrusive)
  const btnStart = $id('btnStartGPS');
  const btnStop = $id('btnStopGPS');
  if(btnStart){
    btnStart.addEventListener('click', function(){
      PATROL.gps.tryCount = 0; tryGetPos();
      // also ensure presence sent
      PATROL.sendPresence();
    });
  }
  if(btnStop){
    btnStop.addEventListener('click', function(){
      if(PATROL.gps.watchId !== null){ navigator.geolocation.clearWatch(PATROL.gps.watchId); PATROL.gps.watchId = null; }
      PATROL.sendPresence({ online:false });
    });
  }
  // Also expose function to request GPS
  PATROL.requestGPS = tryGetPos;

  // Photo upload wiring: if input#photoInput exists, hook and upload to storage
  const photoInput = $id('photoInput');
  if(photoInput){
    photoInput.addEventListener('change', async function(e){
      const f = e.target.files && e.target.files[0]; if(!f) return;
      if(!PATROL.uid){ alert('Belum login'); return; }
      // basic size limit and image compression could be added; keep simple now
      const id = 'p_'+Date.now();
      const path = `live_photos/${PATROL.uid}/${id}_${f.name}`;
      const task = storage.ref(path).put(f);
      task.on('state_changed', ()=>{}, function(err){ console.error('upload err', err); alert('Upload gagal'); }, async function(){
        const url = await storage.ref(path).getDownloadURL();
        const payload = { id, url, meta:{ name: f.name, size: f.size, type: f.type }, uploadedAt: Date.now() };
        await db.ref('/live/'+PATROL.uid+'/photos/'+id).set(payload).catch(()=>{});
        await db.ref('/history/'+PATROL.uid+'/'+Date.now()).set({ type:'photo', data: payload, ts: Date.now() }).catch(()=>{});
        const photoResult = $id('photoResult'); if(photoResult) photoResult.innerHTML = `<div>Foto terupload — <a href="${url}" target="_blank">open</a></div>`;
      });
    });
  }

  // Signature canvas wiring: if canvas#sigCanvas exists
  const sigCanvas = $id('sigCanvas');
  if(sigCanvas){
    const ctx = sigCanvas.getContext('2d');
    let drawing=false, last=null;
    function getPos(e){ const r=sigCanvas.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: t.clientX - r.left, y: t.clientY - r.top }; }
    sigCanvas.addEventListener('mousedown', e=>{ drawing=true; last=getPos(e); });
    sigCanvas.addEventListener('mousemove', e=>{ if(!drawing) return; const c=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(c.x,c.y); ctx.lineWidth=2; ctx.stroke(); last=c; });
    sigCanvas.addEventListener('mouseup', e=> drawing=false);
    sigCanvas.addEventListener('touchstart', e=>{ drawing=true; last=getPos(e); }, {passive:false});
    sigCanvas.addEventListener('touchmove', e=>{ if(!drawing) return; const c=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(c.x,c.y); ctx.lineWidth=2; ctx.stroke(); last=c; }, {passive:false});
    // buttons
    const btnSave = $id('btnSaveSig'), btnClear = $id('btnClearSig'), sigStatus = $id('sigStatus');
    if(btnClear) btnClear.addEventListener('click', ()=>{ ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); if(sigStatus) sigStatus.textContent=''; });
    if(btnSave){
      btnSave.addEventListener('click', async function(){
        if(!PATROL.uid){ alert('Belum login'); return; }
        const dataUrl = sigCanvas.toDataURL('image/png');
        function dataURLtoBlob(dataurl){ var arr=dataurl.split(','), mime=arr[0].match(/:(.*?);/)[1], bstr=atob(arr[1]), n=bstr.length, u8arr=new Uint8Array(n); while(n--) u8arr[n]=bstr.charCodeAt(n); return new Blob([u8arr], {type:mime}); }
        const blob = dataURLtoBlob(dataUrl);
        const key = 'sign_'+Date.now()+'.png'; const path = `signatures/${PATROL.uid}/${key}`;
        const snap = await storage.ref(path).put(blob);
        const url = await storage.ref(path).getDownloadURL();
        await db.ref('/live/'+PATROL.uid+'/signature').set({ url, ts: Date.now() }).catch(()=>{});
        await db.ref('/history/'+PATROL.uid+'/'+Date.now()).set({ type:'signature', data:{url}, ts: Date.now() }).catch(()=>{});
        if(sigStatus) sigStatus.textContent = 'Tanda tangan tersimpan';
      });
    }
  }

  // Add area button wiring (if exists)
  const btnAddArea = $id('btnAddArea');
  if(btnAddArea){
    btnAddArea.addEventListener('click', function(){
      if(!PATROL.uid){ alert('Belum login'); return; }
      const nameEl = $id('newAreaName'); const name = nameEl ? nameEl.value.trim() : ('area_'+Date.now());
      if(!name) return alert('Isi nama area');
      const areaId = 'a_'+Math.random().toString(36).slice(2,8);
      const val = { id: areaId, name: name, createdAt: Date.now() };
      db.ref('/live/'+PATROL.uid+'/areas/'+areaId).set(val).catch(()=>{});
      db.ref('/history/'+PATROL.uid+'/'+Date.now()).set({ type:'area', data: val, ts: Date.now() }).catch(()=>{});
      alert('Area terkirim');
      if(nameEl) nameEl.value = '';
    });
  }

  // Expose send helper for existing HTML scripts: dispatch custom event or call PATROL.send()
  PATROL.send = function(obj){
    if(!PATROL.uid) return;
    db.ref('/live/'+PATROL.uid).update(Object.assign({ updatedAt: Date.now() }, obj)).catch(()=>{});
  };
  // Also support DOM event 'patrol:send' with detail payload
  window.addEventListener('patrol:send', function(e){ try{ PATROL.send(e.detail || {}); }catch(err){}});

  console.log('Integration patch loaded (non-intrusive). PATROL ready state will be true after auth.');
})();
</script>
<!-- END INTEGRATION PATCH -->
</body>
</html>
