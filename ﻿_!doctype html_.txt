<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Patroli — User App (Front camera, Multi-photo, Signature)</title>

  <style>
    :root{
      --bg:#0b0b0b; --card:#0f1720; --accent:#b71c1c; --muted:#bfc7cf; --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, Arial, sans-serif; color:#eef2f5;
    }
    body{margin:0;background:linear-gradient(180deg,#070707,#0b0b0b);min-height:100vh}
    .wrap{max-width:900px;margin:18px auto;padding:18px;box-sizing:border-box}
    .card{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    h1{margin:0 0 8px;font-size:20px;color:var(--accent)}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input[type="text"], textarea, select {width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button.btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    #videoPreview{width:100%;max-height:360px;border-radius:10px;background:#000;object-fit:cover}
    .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .thumb{width:110px;height:80px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
    .sigPad{border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#010101}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .status{margin-top:8px;font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Patroli — User App (Front camera)</h1>
      <div class="small">Pastikan halaman ini di-load via HTTPS (GitHub Pages atau server). Akses kamera akan diminta.</div>

      <label for="name">Nama Petugas</label>
      <input id="name" placeholder="Nama lengkap / ID petugas" type="text"/>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="shift">Shift</label>
          <select id="shift">
            <option value="">Pilih shift</option>
            <option value="pagi">PAGI</option>
            <option value="siang">SIANG</option>
            <option value="malam">MALAM</option>
          </select>
        </div>
        <div class="col">
          <label for="status">Status singkat</label>
          <input id="status" placeholder="ex: on patrol / standby" type="text"/>
        </div>
      </div>

      <label for="desc">Deskripsi / Catatan</label>
      <textarea id="desc" placeholder="Keterangan patroli, kondisi, temuan"></textarea>

      <label>Live camera (depan) — tekan ambil untuk capture</label>
      <video id="videoPreview" autoplay playsinline></video>
      <div class="buttons">
        <button id="btnStartCam" class="btn">Mulai Kamera Depan</button>
        <button id="btnCapture" class="btn">Ambil Foto (front)</button>
        <button id="btnAddFromFile" class="btn">Upload dari File</button>
      </div>

      <div class="thumbs" id="thumbs"></div>

      <label style="margin-top:10px">Signature (tanda tangan)</label>
      <canvas id="sigCanvas" class="sigPad" width="540" height="160"></canvas>
      <div class="buttons">
        <button id="btnClearSig" class="btn">Hapus Tanda Tangan</button>
        <button id="btnSaveSig" class="btn">Simpan Signature</button>
      </div>
      <div id="sigPreview" class="note"></div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn primary">Kirim / Mulai Patroli</button>
        <div id="gpsStatus" class="small">GPS: belum ter-set</div>
      </div>

      <div id="statusBox" class="status"></div>
      <div class="note">Foto & signature di-upload ke Cloudinary (unsigned preset) lalu URL disimpan ke Firebase Realtime DB di bawah `/patroli`.</div>
    </div>

    <footer class="card small">Built-for: Patroli • Front camera capture • Multi-photo • Signature • Anonymous Firebase auth</footer>
  </div>

<script>
/* =================== CONFIG ===================
   - Jika mau pake project lain, ganti firebaseConfig.
   - Buat di Cloudinary: unsigned upload preset (untuk client-side upload).
   =============================================== */

/* ----- Firebase config (pakai yang Lo punya) ----- */
const firebaseConfig = {
  apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
  authDomain: "silitpitik7373.firebaseapp.com",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  projectId: "silitpitik7373",
  storageBucket: "silitpitik7373.firebasestorage.app",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};

/* ----- Cloudinary (isi sendiri) ----- */
const CLOUDINARY_UPLOAD_PRESET = 'YOUR_UNSIGNED_UPLOAD_PRESET';
const CLOUDINARY_CLOUD_NAME = 'YOUR_CLOUD_NAME';
/* Example:
   CLOUDINARY_UPLOAD_PRESET = 'patroli_unsigned_123';
   CLOUDINARY_CLOUD_NAME = 'mycloudname';
*/

(function init(){
  /* load Firebase compat libs dynamically (simple) */
  const s1 = document.createElement('script'); s1.src = "https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"; s1.onload = ()=> {
    const s2 = document.createElement('script'); s2.src = "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js";
    const s3 = document.createElement('script'); s3.src = "https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js";
    document.head.appendChild(s2); document.head.appendChild(s3);
    s3.onload = main;
  };
  document.head.appendChild(s1);

  // helpers
  function by(id){ return document.getElementById(id); }
  function setStatus(msg, isErr=false){ const el = by('statusBox'); el.innerText = msg; el.style.color = isErr? '#ffb4b4':'#bfe7c3'; }
  function setGPS(msg){ by('gpsStatus').innerText = 'GPS: ' + msg; }

  async function main(){
    // init firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // do anonymous sign-in (if not signed in)
    auth.onAuthStateChanged(user=>{
      if(user){
        console.log('signed in uid:', user.uid);
      } else {
        auth.signInAnonymously().catch(err=> {
          console.error('anon sign in err', err); setStatus('Gagal sign-in anonim: ' + err.message, true);
        });
      }
    });

    // DOM refs
    const video = by('videoPreview');
    const btnStartCam = by('btnStartCam');
    const btnCapture = by('btnCapture');
    const btnAddFromFile = by('btnAddFromFile');
    const thumbs = by('thumbs');
    const sigCanvas = by('sigCanvas');
    const btnClearSig = by('btnClearSig');
    const btnSaveSig = by('btnSaveSig');
    const sigPreview = by('sigPreview');
    const btnSubmit = by('btnSubmit');

    // state
    let stream = null;
    let photos = []; // store {blob, url} before upload
    let signatureDataUrl = null;
    let currentPos = null;

    // init signature canvas simple
    const ctx = sigCanvas.getContext('2d');
    ctx.fillStyle = '#0b0b0b'; ctx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
    let drawing=false;
    let lastX=0,lastY=0;
    function posFromEvt(e){
      const rect = sigCanvas.getBoundingClientRect();
      if(e.touches && e.touches[0]) {
        return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
      } else {
        return {x: e.clientX - rect.left, y: e.clientY - rect.top};
      }
    }
    sigCanvas.addEventListener('pointerdown', (e)=>{ drawing=true; const p=posFromEvt(e); lastX=p.x; lastY=p.y; });
    sigCanvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; const p=posFromEvt(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
    window.addEventListener('pointerup', ()=>{ drawing=false; });

    btnClearSig.addEventListener('click', ()=>{
      ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); ctx.fillStyle='#0b0b0b'; ctx.fillRect(0,0,sigCanvas.width,sigCanvas.height); signatureDataUrl = null; sigPreview.innerText = 'Signature cleared';
    });

    btnSaveSig.addEventListener('click', ()=>{
      signatureDataUrl = sigCanvas.toDataURL('image/png');
      sigPreview.innerHTML = `<div class="small">Signature saved (preview):</div><img style="max-width:100%;margin-top:6px;border-radius:6px" src="${signatureDataUrl}"/>`;
    });

    // start camera front
    btnStartCam.addEventListener('click', async ()=>{
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; video.srcObject = null; btnStartCam.innerText = 'Mulai Kamera Depan'; return; }
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "user" } }, audio:false });
        video.srcObject = stream;
        btnStartCam.innerText = 'Stop Kamera';
      }catch(err){
        console.error(err); setStatus('Gagal akses kamera: ' + err.message, true);
      }
    });

    // capture from video
    btnCapture.addEventListener('click', ()=>{
      if(!video || !video.videoWidth){ setStatus('Video belum siap. Tekan "Mulai Kamera Depan" dulu.', true); return; }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const c = canvas.getContext('2d');
      // mirror if front camera for natural selfie effect
      c.translate(canvas.width, 0); c.scale(-1,1);
      c.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      const img = new Image(); img.src = dataUrl; img.className='thumb';
      thumbs.appendChild(img);
      photos.push({dataUrl});
      setStatus('Foto ditambahkan (belum di-upload). Total foto: ' + photos.length);
    });

    // upload file from device (fallback)
    btnAddFromFile.addEventListener('click', ()=>{
      const input = document.createElement('input');
      input.type = 'file'; input.accept='image/*'; input.multiple=false;
      input.onchange = (ev)=>{
        const f = ev.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          const dataUrl = reader.result;
          const img = new Image(); img.src = dataUrl; img.className='thumb';
          thumbs.appendChild(img);
          photos.push({dataUrl});
          setStatus('Foto dari file ditambahkan. Total foto: ' + photos.length);
        };
        reader.readAsDataURL(f);
      };
      input.click();
    });

    // get geo
    async function tryGetGeo(){
      return new Promise((res, rej)=>{
        if(!navigator.geolocation) return rej(new Error('Geolocation tidak didukung'));
        navigator.geolocation.getCurrentPosition(pos=>{
          currentPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          setGPS(`${currentPos.lat.toFixed(5)}, ${currentPos.lng.toFixed(5)}`);
          res(currentPos);
        }, err=>{
          setGPS('Gagal: ' + err.message);
          rej(err);
        }, {enableHighAccuracy:true, timeout:10000});
      });
    }

    // Cloudinary upload (client-side unsigned)
    async function uploadDataUrlToCloudinary(dataUrl){
      if(!CLOUDINARY_UPLOAD_PRESET || !CLOUDINARY_CLOUD_NAME) throw new Error('Cloudinary preset/cloud name belum diisi');
      // Cloudinary accepts base64 data URIs via key 'file'
      const form = new FormData();
      form.append('file', dataUrl);
      form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
      const resp = await fetch(url, {method:'POST', body: form});
      if(!resp.ok) throw new Error('Cloudinary upload failed: ' + resp.status);
      const json = await resp.json();
      return json.secure_url || json.url;
    }

    // prepare and submit
    btnSubmit.addEventListener('click', async ()=>{
      try{
        setStatus('Mempersiapkan data…');
        // basic fields
        const name = document.getElementById('name').value.trim() || 'PetugasAnon';
        const desc = document.getElementById('desc').value.trim();
        const shift = document.getElementById('shift').value;
        const status = document.getElementById('status').value.trim();

        // get geo (best effort)
        try { await tryGetGeo(); } catch(e){ console.warn('no geo', e); }

        // upload photos if any
        const uploadedPhotoUrls = [];
        if(photos.length){
          setStatus('Meng-upload foto ke Cloudinary…');
          for(let i=0;i<photos.length;i++){
            const p = photos[i];
            if(p.uploadedUrl){ uploadedPhotoUrls.push(p.uploadedUrl); continue; }
            try{
              const url = await uploadDataUrlToCloudinary(p.dataUrl);
              uploadedPhotoUrls.push(url);
              p.uploadedUrl = url;
            }catch(err){
              console.error('upload photo err', err);
              // continue but warn
              setStatus('Gagal upload salah satu foto: ' + (err.message||err), true);
            }
          }
        }

        // upload signature if available (dataURL)
        let sigUrl = null;
        if(signatureDataUrl){
          setStatus('Meng-upload signature…');
          try{
            sigUrl = await uploadDataUrlToCloudinary(signatureDataUrl);
          }catch(err){
            console.error('sig upload err', err);
            setStatus('Gagal upload signature: ' + err.message, true);
          }
        }

        // compose payload
        const payload = {
          name,
          description: desc || '',
          shift: shift || '',
          status: status || 'patroli',
          photos: uploadedPhotoUrls,
          signatureUrl: sigUrl || '',
          timestamp: Date.now(),
          lat: currentPos ? currentPos.lat : null,
          lng: currentPos ? currentPos.lng : null
        };

        // push to DB
        setStatus('Menyimpan data ke Firebase…');
        const ref = db.ref('/patroli').push();
        await ref.set(payload);
        setStatus('Sukses! Data tersimpan. ID: ' + ref.key);
        // reset UI minimal
        photos = []; thumbs.innerHTML=''; signatureDataUrl=null; sigPreview.innerHTML='';
      }catch(err){
        console.error(err);
        setStatus('Gagal kirim: ' + (err.message || err), true);
      }
    });

    // helper UI status
    function setStatus(msg, isErr=false){
      const el = document.getElementById('statusBox'); el.innerText = msg; el.style.color = isErr? '#ffb4b4':'#bfe7c3';
    }
    window.setStatus = setStatus; // debug global
  } // end main
})(); // init
</script>
</body>
</html>