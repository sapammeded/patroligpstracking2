<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FORM PATROLI PROFESIONAL SECURITY</title>
<!-- Library JS PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Font Awesome untuk ikon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Variabel Warna Tailwind */
:root {
  --primary: #0b3d91;
  --primary-dark: #082a6b;
  --primary-light: #1e56c9;
  --secondary: #4f46e5;
  --secondary-dark: #4338ca;
  --accent: #10b981;
  --accent-dark: #059669;
  --warning: #f59e0b;
  --warning-dark: #d97706;
  --danger: #ef4444;
  --danger-dark: #dc2626;
  --info: #0ea5e9;
  --info-dark: #0284c7;
  --background: #f3f4f6; /* grey-100 */
  --surface: #ffffff;
  --text-primary: #1f2937; /* grey-800 */
  --text-secondary: #6b7280; /* grey-500 */
}

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--background);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
}

#appContainer {
  max-width: 600px;
  width: 100%;
  min-height: 100vh;
  background-color: var(--surface);
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
}

.header {
  background-color: var(--primary);
  color: white;
  padding: 1rem;
  text-align: center;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.tabs {
  display: flex;
  justify-content: space-around;
  background-color: var(--surface);
  border-bottom: 2px solid var(--background);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.tab-btn {
  flex-grow: 1;
  padding: 1rem 0.5rem;
  background-color: transparent;
  border: none;
  cursor: pointer;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.2s;
  border-bottom: 3px solid transparent;
}

.tab-btn.active {
  color: var(--primary-dark);
  border-bottom-color: var(--primary);
}

.tab-content {
  padding: 1rem;
}

.card {
  background-color: var(--surface);
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  margin-bottom: 1rem;
  border-left: 5px solid var(--primary-light);
}

.input-group, .textarea-group {
  margin-bottom: 1rem;
}

label {
  display: block;
  margin-bottom: 0.3rem;
  font-weight: 500;
  color: var(--text-primary);
  font-size: 0.9rem;
}

input[type="text"], input[type="date"], input[type="file"], textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db; /* grey-300 */
  border-radius: 6px;
  box-sizing: border-box;
  font-size: 1rem;
  transition: border-color 0.2s;
}

input:focus, textarea:focus {
  border-color: var(--primary-light);
  outline: none;
  box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 0.75rem 1.25rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background-color 0.2s, opacity 0.2s;
  font-size: 1rem;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
  width: 100%;
}

.btn-primary:hover {
  background-color: var(--primary-dark);
}

.btn-danger {
  background-color: var(--danger);
  color: white;
  padding: 0.5rem 1rem;
}

.btn-danger:hover {
  background-color: var(--danger-dark);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.area-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  border-bottom: 1px solid var(--background);
}

.area-list-item:last-child {
  border-bottom: none;
}

.area-title {
  font-weight: 600;
  max-width: 60%; /* Batasi lebar nama */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.area-status {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.area-status.success {
  color: var(--accent-dark);
  font-weight: 700;
}
.area-status.loading {
  color: var(--warning-dark);
  font-weight: 700;
}


.toast {
  visibility: hidden;
  min-width: 250px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 16px;
  position: fixed;
  z-index: 1;
  left: 50%;
  transform: translateX(-50%);
  bottom: 30px;
  font-size: 1rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.toast.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;} 
  to {bottom: 30px; opacity: 1;}
}

@keyframes fadeout {
  from {opacity: 1;} 
  to {opacity: 0;}
}

/* Modal Styling */
.modal {
  display: none; 
  position: fixed; 
  z-index: 1000; 
  left: 0;
  top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto; 
  background-color: rgba(0,0,0,0.6); 
}

.modal-content {
  background-color: var(--surface);
  margin: 15% auto; 
  padding: 20px;
  border-radius: 8px;
  width: 90%; 
  max-width: 400px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}

.modal-content h2 {
    margin-top: 0;
    color: var(--primary-dark);
}

.modal-content p {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}
.route-status-display {
    text-align: center;
    padding: 0.75rem;
    border-radius: 6px;
    margin-top: 1rem;
    font-weight: 600;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
}

.status-not-started {
    background-color: #fce7f3; /* pink-100 */
    color: var(--danger-dark);
}

.status-in-progress {
    background-color: #d1fae5; /* green-100 */
    color: var(--accent-dark);
}

.status-completed {
    background-color: #bfdbfe; /* blue-200 */
    color: var(--primary-dark);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 1rem;
}
.stat-item {
    background-color: var(--background);
    padding: 10px;
    border-radius: 6px;
    text-align: center;
}
.stat-item .value {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-dark);
}
.stat-item .label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.capture-form-content p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-style: italic;
    padding: 5px;
    border: 1px dashed #e5e7eb;
    border-radius: 4px;
}

</style>
</head>
<body>

<div id="appContainer">
    <div class="header">
        <h1>Form Patroli GPS</h1>
        <p>Laporan Keamanan Digital</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="formTab"><i class="fas fa-list-ul"></i> Form</button>
        <button class="tab-btn" data-tab="reportTab" id="reportTabBtn" disabled><i class="fas fa-file-pdf"></i> Laporan</button>
    </div>

    <div class="tab-content" id="formTab">
        <!-- Status Tracking -->
        <div id="routeStatusDisplay" class="route-status-display status-not-started">
            <span id="routeStatus">Tracking Belum Dimulai</span>
        </div>
        
        <!-- Tracking Control Buttons -->
        <div style="margin-top: 10px; margin-bottom: 1rem; display: flex; gap: 10px;">
            <button class="btn btn-primary" id="startTrackingBtn" style="flex-grow: 1;">
                <i class="fas fa-play"></i> Mulai Tracking GPS (Aktifkan Layar)
            </button>
            <button class="btn btn-danger" id="stopTrackingBtn" style="flex-grow: 1;" disabled>
                <i class="fas fa-stop"></i> Hentikan Tracking & Lepas Layar
            </button>
        </div>


        <!-- Meta Data -->
        <div class="card">
            <h2>Data Utama</h2>
            <div class="input-group">
                <label for="petugas">Nama Petugas</label>
                <input type="text" id="petugas" placeholder="Masukkan Nama Petugas" required>
            </div>
            <div class="input-group">
                <label for="tanggal">Tanggal Patroli</label>
                <input type="date" id="tanggal" required>
            </div>
        </div>

        <!-- Area Checkpoint -->
        <div class="card">
            <h2>Area Checkpoint Patroli (Unlimited)</h2>
            <div id="areaList">
                <!-- Lokasi Patroli akan di-render di sini -->
            </div>
            
            <button class="btn btn-primary" id="addNewAreaBtn"><i class="fas fa-map-marker-alt"></i> Tambah Lokasi Patroli Baru</button>
        </div>

    </div>

    <div class="tab-content" id="reportTab" style="display:none;">
        <div class="card">
            <h2>Ringkasan Patroli</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="value" id="totalAreasStat">0</div>
                    <div class="label">Total Area</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="completedAreasStat">0</div>
                    <div class="label">Area Selesai</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="totalPhotosStat">0</div>
                    <div class="label">Foto Diambil</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="totalCleanupSize">0 KB</div>
                    <div class="label">Data Tersimpan</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Hasil Laporan</h2>
            <p id="reportMsg">Isi form patroli terlebih dahulu.</p>
            <button class="btn btn-primary" id="generatePdfBtn" disabled><i class="fas fa-file-export"></i> Buat Laporan PDF</button>
            <button class="btn btn-danger" id="clearDataBtn" style="margin-top: 10px; width: 100%;"><i class="fas fa-trash"></i> Hapus Semua Data Lokal</button>
        </div>
    </div>
</div>

<!-- Modal untuk Permintaan Izin -->
<div id="permissionModal" class="modal">
    <div class="modal-content">
        <h2>Perhatian: Izin Diperlukan</h2>
        <p>Aplikasi ini membutuhkan akses ke **Kamera** (untuk bukti foto) dan **Lokasi GPS** (untuk mencatat rute patroli).</p>
        <p>Mohon izinkan akses saat diminta oleh browser. Setelah itu, klik **Mulai Tracking GPS** untuk mengaktifkan pelacakan status dan mengunci layar agar tidak tidur.</p>
        <button class="btn btn-primary" id="grantPermissionBtn">Lanjut & Berikan Izin</button>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<script>
// Variabel Global
let data = {
    meta: {
        petugas: '',
        tanggal: new Date().toISOString().split('T')[0],
        trackingStarted: null,
        trackingEnded: null,
    },
    // Status baru: 'pending', 'loading_gps', 'completed'
    areas: [] // {id: 'uuid', name: 'Area X', status: 'pending', lat: null, lon: null, photo: null, notes: ''}
};
let watchId = null; // ID untuk geolocation watch (hanya untuk status UI)
let isTracking = false; // Status tracking
let wakeLock = null; // Tambahkan variabel untuk Wake Lock

// --- UTILITIES ---

// Inisialisasi Firebase (Gunakan variabel global Canvas)
// Konfigurasi Firebase disiapkan untuk kompatibilitas, meskipun saat ini menggunakan LocalStorage.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Fungsi untuk menampilkan Toast Notification
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = "toast show";
    setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
}

// Fungsi untuk memuat data dari localStorage
function loadData() {
    const storedData = localStorage.getItem('patroliData');
    if (storedData) {
        try {
            const parsedData = JSON.parse(storedData);
            // Gabungkan data lama dengan struktur baru untuk menghindari error
            data = {
                meta: { ...data.meta, ...parsedData.meta },
                areas: parsedData.areas || []
            };
            
            // Perbarui UI input meta data
            document.getElementById('petugas').value = data.meta.petugas;
            document.getElementById('tanggal').value = data.meta.tanggal;
        } catch (e) {
            console.error("Error parsing localStorage data:", e);
            // Lanjut dengan data default jika parsing gagal
        }
    } else {
        // Inisialisasi tanggal default hari ini jika tidak ada data
        document.getElementById('tanggal').value = data.meta.tanggal;
    }
}

// Fungsi untuk menyimpan data ke localStorage
function saveData() {
    localStorage.setItem('patroliData', JSON.stringify(data));
}

// Persist Meta Data (dipanggil saat input petugas/tanggal berubah)
function persistMeta() {
    data.meta.petugas = document.getElementById('petugas').value;
    data.meta.tanggal = document.getElementById('tanggal').value;
    saveData();
    updateRouteStatusUI();
}

// --- WAKE LOCK API (FIXED BACKGROUND) ---
// Fungsi untuk meminta agar layar tetap menyala
async function requestWakeLock() {
    if ('wakeLock' in navigator && !wakeLock) {
        try {
            // Meminta screen wake lock
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock dilepas oleh sistem.');
                wakeLock = null;
                updateRouteStatusUI();
            });
            console.log('Wake Lock berhasil didapatkan!');
            return true;
        } catch (err) {
            console.error('Gagal mendapatkan wake lock:', err);
            showToast('⚠️ Gagal mengunci layar. Layar mungkin akan mati secara normal.');
            wakeLock = null;
            return false;
        }
    }
    return false;
}

// Fungsi untuk melepaskan wake lock
function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Wake Lock dilepas.');
    }
}

// --- GEOLOCATION & TRACKING (WatchPosition HANYA untuk status UI) ---

// Fungsi yang dipanggil saat lokasi berhasil didapatkan (dari watchPosition)
function successCallback(position) {
    const { latitude, longitude } = position.coords;
    
    // Perbarui UI status tracking
    document.getElementById('routeStatus').innerHTML = `<i class="fas fa-location-arrow"></i> Tracking Aktif: Lat ${latitude.toFixed(4)}, Lon ${longitude.toFixed(4)} ${wakeLock ? '<span style="color: var(--warning-dark);">(Layar Terkunci)</span>' : ''}`;
    document.getElementById('routeStatusDisplay').className = 'route-status-display status-in-progress';
    
    // Jika tracking baru dimulai, catat waktu mulai
    if (!data.meta.trackingStarted) {
        data.meta.trackingStarted = new Date().toISOString();
        saveData();
    }
}

// Fungsi yang dipanggil saat terjadi error Geolocation
function errorCallback(error) {
    // Logging error watchPosition
    console.warn("WatchPosition Error:", error);
    
    // Hanya perbarui UI status jika masih mencoba tracking
    if (isTracking) {
        const message = error.code === 1 ? "Izin Lokasi Ditolak." : 
                        error.code === 2 ? "Lokasi Tidak Tersedia." : 
                        "Kesalahan GPS Tidak Dikenal.";
        document.getElementById('routeStatus').innerHTML = `<i class="fas fa-exclamation-triangle"></i> Tracking Terganggu: ${message} ${wakeLock ? '<span style="color: var(--warning-dark);">(Layar Terkunci)</span>' : ''}`;
        document.getElementById('routeStatusDisplay').className = 'route-status-display status-not-started';
    }
}

// Fungsi untuk memulai Live Tracking GPS (HANYA untuk update status UI)
async function startTracking() {
    if (isTracking) return;
    
    // 1. Coba Minta Wake Lock
    await requestWakeLock();

    if (navigator.geolocation) {
        isTracking = true;
        
        // Mulai watchPosition untuk update status lokasi di UI secara berkala
        watchId = navigator.geolocation.watchPosition(
            successCallback,
            errorCallback,
            {
                enableHighAccuracy: true,
                timeout: 15000, // 15 detik
                maximumAge: 0
            }
        );
        document.getElementById('routeStatus').textContent = 'Memulai Live Tracking...';
        document.getElementById('routeStatusDisplay').className = 'route-status-display status-in-progress';
        
        // Catat waktu mulai di meta data
        if (!data.meta.trackingStarted) {
             data.meta.trackingStarted = new Date().toISOString();
             saveData();
        }
        
        updateRouteStatusUI();
        showToast('✅ Status Tracking GPS Dimulai. Layar dikunci. Klik "Catat Lokasi" untuk merekam koordinat.');

    } else {
        showToast("Browser Anda tidak mendukung Geolocation.");
        isTracking = false;
        releaseWakeLock(); // Lepas lock jika gagal
        updateRouteStatusUI();
    }
}

// Fungsi untuk menghentikan Live Tracking GPS
function stopTracking(isCompleted = false) {
    if (!isTracking) return;

    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }

    isTracking = false;
    data.meta.trackingEnded = new Date().toISOString();
    saveData();
    
    releaseWakeLock(); // Lepaskan Wake Lock

    if (isCompleted) {
        document.getElementById('routeStatus').textContent = 'Patroli Selesai & Tracking Dihentikan!';
        document.getElementById('routeStatusDisplay').className = 'route-status-display status-completed';
        showToast('✅ Patroli Selesai! Layar kembali normal. Silakan cek tab Laporan.');
    } else {
        document.getElementById('routeStatus').textContent = 'Tracking Dihentikan.';
        document.getElementById('routeStatusDisplay').className = 'route-status-display status-not-started';
        showToast('🛑 Tracking GPS dihentikan manual. Layar kembali normal.');
    }
    updateRouteStatusUI();
}

// --- AREA MANAGEMENT ---

// Fungsi untuk merender daftar area
function renderAreas() {
    const areaList = document.getElementById('areaList');
    areaList.innerHTML = '';
    
    if (data.areas.length === 0) {
        areaList.innerHTML = '<p class="text-secondary" style="font-style: italic;">Belum ada lokasi patroli ditambahkan.</p>';
    } 

    // Tombol Laporan hanya aktif jika ada area DAN semua selesai
    const allCompleted = data.areas.length > 0 && data.areas.every(a => a.status === 'completed');
    document.getElementById('reportTabBtn').disabled = !allCompleted;
    
    data.areas.forEach(area => {
        let statusClass = '';
        let statusText = 'Pending';
        let captureBtnText = 'Catat Lokasi & Foto';
        let captureBtnIcon = 'fas fa-camera';
        let btnDisabled = '';
        
        if (area.status === 'completed') {
            statusClass = 'success';
            statusText = 'Selesai';
            captureBtnText = 'Lihat/Edit';
            captureBtnIcon = 'fas fa-eye';
        } else if (area.status === 'loading_gps') {
            statusClass = 'loading';
            statusText = 'Memuat Lokasi...';
            captureBtnText = 'Mencari GPS...';
            captureBtnIcon = 'fas fa-spinner fa-spin';
            btnDisabled = 'disabled';
        }

        const areaDiv = document.createElement('div');
        areaDiv.className = 'card area-list-item';
        areaDiv.innerHTML = `
            <div>
                <div class="area-title">${area.name}</div>
                <div class="area-status ${statusClass}">${statusText}</div>
            </div>
            <button class="btn btn-primary btn-small" data-area-id="${area.id}" 
                    onclick="startCapture('${area.id}')"
                    ${btnDisabled}>
                <i class="${captureBtnIcon}"></i> ${captureBtnText}
            </button>
        `;
        areaList.appendChild(areaDiv);
    });
    
    updateCleanupStats();
}

// Fungsi untuk menambah area baru (dialog sederhana)
function addNewArea() {
    const areaName = prompt("Masukkan Nama Lokasi Patroli Baru (e.g., Gerbang Utama, Pos Satpam):");
    if (areaName && areaName.trim()) {
        const newArea = {
            id: crypto.randomUUID(),
            name: areaName.trim(),
            status: 'pending',
            lat: null,
            lon: null,
            photo: null, // Base64 string of the photo
            notes: ''
        };
        data.areas.push(newArea);
        saveData();
        renderAreas();
        showToast(`Area '${areaName.trim()}' berhasil ditambahkan.`);
    }
}

// Fungsi untuk memulai proses capture (Fungsi FIX KRITIS GPS)
function startCapture(areaId) {
    const area = data.areas.find(a => a.id === areaId);
    if (!area) return;

    // Jika sudah selesai, langsung buka form untuk edit/lihat
    if (area.status === 'completed') {
        openCaptureForm(areaId);
        return;
    }
    
    // Pastikan tracking status sudah dimulai
    if (!isTracking) {
        showToast('❌ Live Tracking GPS harus dimulai (klik tombol "Mulai Tracking GPS") sebelum mencatat lokasi!');
        return;
    }

    // 1. Tampilkan status Loading
    area.status = 'loading_gps';
    saveData();
    renderAreas();
    
    showToast('⏳ Mencari koordinat GPS baru... Harap tunggu sebentar.');

    // 2. Gunakan getCurrentPosition (one-time request) untuk mendapatkan koordinat segar
    navigator.geolocation.getCurrentPosition(
        (position) => {
            // SUCCESS
            const { latitude, longitude } = position.coords;
            
            // Hapus form capture yang mungkin terbuka sebelumnya
            document.querySelectorAll('[id^="captureForm-"]').forEach(form => form.remove());

            area.lat = latitude;
            area.lon = longitude;
            area.status = 'pending'; // Kembali ke pending, tapi sudah punya koordinat
            saveData();
            renderAreas();
            
            showToast('✅ Koordinat GPS berhasil didapatkan. Sekarang ambil foto dan catat!');
            openCaptureForm(areaId); // Buka form
        },
        (error) => {
            // ERROR
            area.status = 'pending'; // Kembali ke status awal
            saveData();
            renderAreas();
            
            const errorMessages = {
                1: "Izin Lokasi Ditolak. Cek izin browser Anda.",
                2: "Lokasi tidak tersedia (sinyal lemah). Coba di tempat terbuka.",
                3: "Waktu permintaan habis. Coba lagi (Timeout).",
            };
            const message = errorMessages[error.code] || "Gagal mendapatkan koordinat GPS. Coba lagi.";
            
            showToast(`❌ Gagal Lokasi: ${message}`);
            console.error("Error getCurrentPosition:", error);
        },
        {
            enableHighAccuracy: true,
            timeout: 15000, // Tambah timeout untuk sinyal lemah
            maximumAge: 0
        }
    );
}


// Fungsi untuk menampilkan form capture (Foto & Notes)
function openCaptureForm(areaId) {
    const area = data.areas.find(a => a.id === areaId);
    if (!area) return;
    
    // Hapus form capture yang mungkin terbuka sebelumnya
    let existingForm = document.getElementById('captureForm-' + areaId);
    if (existingForm) existingForm.remove();
    
    const formDiv = document.createElement('div');
    formDiv.id = 'captureForm-' + areaId;
    formDiv.className = 'card capture-form-content';
    formDiv.innerHTML = `
        <h3><i class="fas fa-edit"></i> Catat Checkpoint: ${area.name}</h3>
        <p>Koordinat Tercatat: **${area.lat ? area.lat.toFixed(6) : 'N/A'}, ${area.lon ? area.lon.toFixed(6) : 'N/A'}**</p>
        
        <div class="input-group">
            <label for="photoFile-${areaId}"><i class="fas fa-camera"></i> Foto Bukti (Maks 10MB)</label>
            <input type="file" id="photoFile-${areaId}" accept="image/*" capture="environment">
            ${area.photo ? `<p style="margin-top: 10px;">✅ Foto Tersimpan: <img src="${area.photo}" style="max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 5px;"></p>` : ''}
        </div>

        <div class="textarea-group">
            <label for="notes-${areaId}"><i class="fas fa-clipboard-list"></i> Catatan Patroli</label>
            <textarea id="notes-${areaId}" rows="3" placeholder="Masukkan catatan penting (Wajib)"></textarea>
        </div>

        <button class="btn btn-primary" onclick="saveCapture('${areaId}')">
            <i class="fas fa-save"></i> Simpan Checkpoint
        </button>
        
        ${area.status === 'completed' ? `<button class="btn btn-danger" style="margin-top: 10px; width: 100%;" onclick="resetCapture('${areaId}')"><i class="fas fa-undo"></i> Reset Checkpoint</button>` : ''}
    `;

    // Cari area list item dan masukkan form setelahnya
    const areaListItem = document.querySelector(`.area-list-item button[data-area-id="${areaId}"]`).parentElement;
    areaListItem.after(formDiv);
    
    // Isi catatan yang sudah ada
    document.getElementById(`notes-${areaId}`).value = area.notes || '';
    
    // Scroll ke form
    formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Set listener untuk file
    document.getElementById(`photoFile-${areaId}`).addEventListener('change', (e) => handlePhotoUpload(e, areaId));
}

// Fungsi untuk menangani upload foto
function handlePhotoUpload(event, areaId) {
    const file = event.target.files[0];
    if (!file) return;

    // Batasi ukuran file 10MB (ditingkatkan dari 5MB)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('❌ Ukuran file terlalu besar! Maksimal 10MB.');
        event.target.value = null; // Clear input
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const area = data.areas.find(a => a.id === areaId);
        area.photo = e.target.result; // Simpan Base64
        saveData();
        // Render ulang form untuk menampilkan preview foto
        openCaptureForm(areaId); 
    };
    reader.readAsDataURL(file);
}

// Fungsi untuk menyimpan data capture
function saveCapture(areaId) {
    const area = data.areas.find(a => a.id === areaId);
    if (!area) return;

    const notes = document.getElementById(`notes-${areaId}`).value;
    
    if (!area.photo) {
        showToast('❌ Mohon ambil foto bukti sebelum menyimpan.');
        return;
    }
    if (!notes.trim()) {
        showToast('❌ Mohon isi Catatan Patroli (Wajib).');
        return;
    }
    
    // Pastikan lokasi sudah tercatat
    if (area.lat === null || area.lon === null) {
         showToast('❌ Gagal merekam koordinat lokasi. Klik "Catat Lokasi & Foto" sekali lagi untuk mendapatkan GPS.');
         return;
    }
    
    area.notes = notes.trim();
    area.status = 'completed';
    
    saveData();
    showToast(`✅ Checkpoint ${area.name} berhasil disimpan.`);

    // Hapus form dan render ulang daftar
    const formEl = document.getElementById('captureForm-' + areaId);
    if(formEl) formEl.remove();
    renderAreas();
    
    // Cek apakah semua area sudah selesai
    const allCompleted = data.areas.every(a => a.status === 'completed');
    if (allCompleted) {
        stopTracking(true); // Otomatis hentikan tracking jika semua selesai
    }
}

// Fungsi untuk mereset status capture
function resetCapture(areaId) {
    if (!window.confirm("Yakin ingin me-reset Checkpoint ini? Data lokasi, foto, dan catatan akan dihapus.")) return;

    const area = data.areas.find(a => a.id === areaId);
    if (!area) return;

    area.status = 'pending';
    area.lat = null;
    area.lon = null;
    area.photo = null;
    area.notes = '';
    
    saveData();
    showToast(`🔄 Checkpoint ${area.name} berhasil di-reset.`);

    // Hapus form dan render ulang daftar
    let existingForm = document.getElementById('captureForm-' + areaId);
    if (existingForm) existingForm.remove();
    renderAreas();
}

// Fungsi untuk menghapus semua data lokal
function clearAllData() {
    if (!window.confirm("PERINGATAN: Anda akan menghapus SEMUA data patroli lokal. Lanjutkan?")) return;
    
    stopTracking(false); // Hentikan tracking jika masih berjalan
    localStorage.removeItem('patroliData');
    data = {
        meta: {
            petugas: '',
            tanggal: new Date().toISOString().split('T')[0],
            trackingStarted: null,
            trackingEnded: null,
        },
        areas: []
    };
    loadData();
    renderAreas();
    updateRouteStatusUI();
    showToast('🗑️ Semua data patroli berhasil dihapus.');
}

// --- PERMISSION HANDLER ---

// Fungsi untuk meminta izin kamera dan lokasi
function requestPermissions() {
    // Tunjukkan modal
    document.getElementById('permissionModal').style.display = 'block';

    document.getElementById('grantPermissionBtn').onclick = () => {
        document.getElementById('permissionModal').style.display = 'none';
        
        // Coba cek izin Geolocation dan Kamera.
        if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // Berhasil mendapatkan izin/posisi pertama
                    showToast('✅ Izin Lokasi OK. Mulai Tracking dan Catat Lokasi Anda.');
                },
                (error) => {
                    // Izin gagal atau ditolak. Berikan peringatan.
                    const errorCode = error && error.code ? error.code : 0; 
                    const errorMessages = { 1: "Lokasi Ditolak", 2: "Lokasi tidak tersedia", 3: "Timeout" };
                    const message = errorMessages[errorCode] || "Error Geolocation tidak dikenal.";
                    showToast(`⚠️ Cek Izin Lokasi: ${message}.`);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            showToast('❌ Browser Anda tidak mendukung Geolocation.');
        }
    };
}


// --- UI / TABS ---

function setupTabSystem() {
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.target.getAttribute('data-tab');
            switchToTab(tabId);
        });
    });
}

function switchToTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.classList.remove('active');
    });

    document.getElementById(tabId).style.display = 'block';
    document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
    
    if (tabId === 'reportTab') {
        updateCleanupStats();
        // Cek apakah data cukup untuk laporan
        const allCompleted = data.areas.length > 0 && data.areas.every(a => a.status === 'completed');
        if (allCompleted && data.meta.petugas && data.meta.tanggal) {
            document.getElementById('generatePdfBtn').disabled = false;
            document.getElementById('reportMsg').textContent = `Laporan siap dibuat untuk Petugas: ${data.meta.petugas}, Tanggal: ${data.meta.tanggal}.`;
        } else {
            document.getElementById('generatePdfBtn').disabled = true;
            document.getElementById('reportMsg').textContent = 'Mohon isi Data Utama dan pastikan SEMUA Area Checkpoint sudah dicatat (Selesai).';
        }
    }
}

// Update Status Tracking UI & Tombol
function updateRouteStatusUI() {
    const statusEl = document.getElementById('routeStatus');
    const displayEl = document.getElementById('routeStatusDisplay');
    const startBtn = document.getElementById('startTrackingBtn');
    const stopBtn = document.getElementById('stopTrackingBtn');
    const allCompleted = data.areas.length > 0 && data.areas.every(a => a.status === 'completed');

    // Status Tracking saat ini
    let currentStatus = '';
    if (isTracking && !statusEl.textContent.includes('Tracking Terganggu')) {
        currentStatus = `<i class="fas fa-location-arrow"></i> Tracking Aktif`;
    } else if (statusEl.textContent.includes('Tracking Terganggu')) {
        currentStatus = statusEl.textContent; // Biarkan pesan error GPS
    } else {
        currentStatus = 'Tracking Belum Dimulai';
    }

    // Tambahkan status Wake Lock
    if (isTracking) {
        if (wakeLock) {
            currentStatus += ` <i class="fas fa-lock" style="color: var(--warning-dark);"></i> Layar Terkunci Aktif`;
            displayEl.className = 'route-status-display status-in-progress';
        } else {
            currentStatus += ` <i class="fas fa-unlock" style="color: var(--danger-dark);"></i> Layar Terkunci GAGAL`;
        }
    } else if (allCompleted) {
        currentStatus = 'Patroli Selesai!';
        displayEl.className = 'route-status-display status-completed';
    } else {
        currentStatus = 'Tracking Belum Dimulai';
        displayEl.className = 'route-status-display status-not-started';
    }

    statusEl.innerHTML = currentStatus;

    if (allCompleted) {
        startBtn.disabled = true;
        stopBtn.disabled = true;
        document.getElementById('reportTabBtn').disabled = false;
    } else if (isTracking) {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        document.getElementById('reportTabBtn').disabled = true;
    } else {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        document.getElementById('reportTabBtn').disabled = true;
    }
}

// Hitung Statistik Laporan
function updateCleanupStats() {
    const totalAreas = data.areas.length;
    const completedAreas = data.areas.filter(a => a.status === 'completed').length;
    const totalPhotos = data.areas.filter(a => a.photo).length;
    
    // Hitung perkiraan ukuran data yang disimpan (Base64)
    let totalSize = 0;
    data.areas.forEach(a => {
        if(a.photo) {
            // Estimasi ukuran Base64 (approx 3/4 byte per karakter)
            totalSize += (a.photo.length * 0.75) / 1024; // KB
        }
    });

    document.getElementById('totalAreasStat').textContent = totalAreas;
    document.getElementById('completedAreasStat').textContent = completedAreas;
    document.getElementById('totalPhotosStat').textContent = totalPhotos;
    document.getElementById('totalCleanupSize').textContent = `${totalSize > 1024 ? (totalSize / 1024).toFixed(2) + ' MB' : totalSize.toFixed(1) + ' KB'}`;
}


// --- PDF GENERATION (JSPDF) ---
function generatePdf() {
    if (!data.meta.petugas || !data.meta.tanggal || data.areas.length === 0 || !data.areas.every(a => a.status === 'completed')) {
        showToast('❌ Lengkapi data utama dan SEMUA checkpoint harus selesai sebelum membuat laporan.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const margin = 15;
    let y = margin;
    const pageWidth = doc.internal.pageSize.getWidth();

    // Judul
    doc.setFontSize(18);
    doc.setTextColor(varToRgb('--primary'));
    doc.text("Laporan Patroli GPS Security", pageWidth / 2, y, { align: "center" });
    y += 10;

    // Subjudul
    doc.setFontSize(12);
    doc.setTextColor(varToRgb('--text-primary'));
    doc.text(`Petugas: ${data.meta.petugas}`, margin, y);
    y += 7;
    doc.text(`Tanggal: ${data.meta.tanggal}`, margin, y);
    y += 7;
    doc.text(`Waktu Tracking: ${data.meta.trackingStarted ? new Date(data.meta.trackingStarted).toLocaleTimeString() : '-'} s/d ${data.meta.trackingEnded ? new Date(data.meta.trackingEnded).toLocaleTimeString() : '-'}`, margin, y);
    y += 10;

    // Ringkasan Statistik
    const statsTableData = [
        ["Total Area Patroli", data.areas.length],
        ["Area Selesai", data.areas.filter(a => a.status === 'completed').length],
        ["Foto Bukti", data.areas.filter(a => a.photo).length]
    ];
    
    doc.autoTable({
        startY: y,
        head: [['Deskripsi', 'Jumlah']],
        body: statsTableData,
        theme: 'striped',
        styles: {
            fontSize: 10,
            cellPadding: 3,
            fillColor: [240, 240, 240] 
        },
        headStyles: {
            fillColor: varToRgb('--primary'),
            textColor: 255
        },
        margin: { left: margin, right: margin }
    });
    y = doc.autoTable.previous.finalY + 10;
    
    // Detail Checkpoint
    doc.setFontSize(14);
    doc.setTextColor(varToRgb('--primary-dark'));
    doc.text("Detail Checkpoint", margin, y);
    y += 5;

    data.areas.forEach((area, index) => {
        // Cek halaman baru
        if (y + 60 > doc.internal.pageSize.getHeight() - margin) {
            doc.addPage();
            y = margin;
        }

        doc.setFontSize(12);
        doc.setTextColor(varToRgb('--primary-dark'));
        doc.text(`(${index + 1}) ${area.name} (${area.status === 'completed' ? 'SELESAI' : 'PENDING'})`, margin, y);
        y += 7;
        
        doc.setFontSize(10);
        doc.setTextColor(varToRgb('--text-primary'));
        doc.text(`Koordinat: ${area.lat || '-'}, ${area.lon || '-'}`, margin, y);
        y += 5;
        // Gunakan autoTable untuk Catatan agar bisa multi-baris
        doc.autoTable({
            startY: y,
            body: [[{ content: `Catatan: ${area.notes || 'Tidak ada catatan.'}`, styles: { cellWidth: 'wrap' } }]],
            theme: 'plain',
            styles: { fontSize: 10, cellPadding: 1, overflow: 'linebreak', textColor: varToRgb('--text-primary') },
            margin: { left: margin, right: margin }
        });
        y = doc.autoTable.previous.finalY; // Ambil posisi Y setelah tabel catatan
        y += 3;

        // Tambahkan foto jika ada
        if (area.photo) {
            try {
                const imgHeight = 40;
                const imgWidth = 80; 

                if (y + imgHeight + 5 > doc.internal.pageSize.getHeight() - margin) {
                    doc.addPage();
                    y = margin;
                }
                
                // Gunakan jspdf built-in method (mungkin perlu format JPG/PNG di base64)
                doc.addImage(area.photo, 'JPEG', margin, y, imgWidth, imgHeight, undefined, 'FAST');
                doc.text('Bukti Foto', margin + imgWidth + 5, y + 5);
                y += imgHeight + 5; 
            } catch (e) {
                console.error("Error adding image to PDF:", e);
                doc.text("Foto gagal ditampilkan di PDF. (Error Base64)", margin, y);
                y += 5;
            }
        } else {
            y += 5;
        }
        y += 5;
    });

    // Simpan PDF
    doc.save(`Laporan_Patroli_${data.meta.petugas}_${data.meta.tanggal}.pdf`);
    showToast('✅ Laporan PDF berhasil dibuat dan didownload!');
}

// Helper untuk konversi variabel CSS ke RGB array
function varToRgb(cssVar) {
    const hex = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
    if (hex.startsWith('#') && hex.length === 7) {
        const r = parseInt(hex.substring(1, 3), 16);
        const g = parseInt(hex.substring(3, 5), 16);
        const b = parseInt(hex.substring(5, 7), 16);
        return [r, g, b];
    }
    return [0, 0, 0]; // Default black
}


// --- EVENT LISTENERS & INIT ---

// Event listener untuk tombol 'Buat Laporan PDF'
document.getElementById('generatePdfBtn').addEventListener('click', generatePdf);

// Event listener untuk tombol 'Hapus Semua Data Lokal'
document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

// Event listener untuk modal izin
document.getElementById('permissionModal').addEventListener('click', function(e) {
    if (e.target.id === 'permissionModal') {
        // Mencegah penutupan modal saat klik di luar
    }
});

// Event listener untuk tombol 'Tambah Lokasi Patroli Baru'
document.getElementById('addNewAreaBtn').addEventListener('click', addNewArea);

// Event listener untuk Live Tracking (Tombol start/stop)
document.getElementById('startTrackingBtn').addEventListener('click', startTracking);
document.getElementById('stopTrackingBtn').addEventListener('click', stopTracking);

// Event listener untuk update data meta (Nama Petugas, Tanggal)
document.getElementById('petugas').addEventListener('input', persistMeta);
document.getElementById('tanggal').addEventListener('change', persistMeta);

// Inisialisasi awal saat halaman dimuat
window.onload = function() {
    loadData();
    setupTabSystem();
    switchToTab('formTab'); 
    renderAreas();
    updateRouteStatusUI(); 
    updateCleanupStats();
    
    // Tunjukkan modal izin di awal
    requestPermissions(); 
};
</script>
</body>
</html>